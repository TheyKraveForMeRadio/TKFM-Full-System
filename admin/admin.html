<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TKFM Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- If this path breaks in prod, switch to /admin/tkfm-theme.css copied into dist/admin -->
  <link rel="stylesheet" href="/src/styles/tkfm-theme.css" />

  <style>
    body{background:#000;color:#fff;font-family:Arial,sans-serif;padding:24px;max-width:1100px;margin:0 auto}
    .card{background:#111;border:1px solid #222;border-radius:12px;padding:16px;margin:14px 0}
    .hidden{display:none}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0b0b0b;color:#fff}
    textarea{min-height:140px;resize:vertical}
    button{padding:10px 12px;border-radius:10px;border:1px solid #333;background:#1b1b1b;color:#fff;cursor:pointer}
    button:hover{border-color:#555}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:#aaa}
    .badge{display:inline-block;padding:4px 10px;border:1px solid #333;border-radius:999px;font-size:12px}
    .ok{color:#7CFFB2}
    .warn{color:#FFD37C}
    .danger{color:#FF7C7C}
    article{padding:14px;border-radius:12px;border:1px solid #222;background:#0d0d0d;margin:10px 0}
    article h3{margin:0 0 6px}
    .meta{font-size:12px;color:#9aa}
  </style>
</head>

<body>
  <h1>TKFM Admin Panel</h1>
  <p class="muted">Restricted access â€” administrators only.</p>

  <!-- LOGIN -->
  <section id="loginCard" class="card">
    <h2>Admin Login</h2>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="adminEmail" type="email" autocomplete="username" />
      </div>
      <div>
        <label>Password</label>
        <input id="adminPassword" type="password" autocomplete="current-password" />
      </div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <button id="btnLogin">Login</button>
      <span id="loginMsg" class="muted"></span>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden">

    <section class="card">
      <div class="toolbar">
        <span class="badge">Token: <span id="tokenStatus" class="warn">unknown</span></span>
        <button id="btnVerify">Verify</button>
        <button id="btnLogout">Logout</button>
        <span id="globalMsg" class="muted"></span>
      </div>
    </section>

    <!-- NEWS -->
    <section class="card">
      <h2>ðŸ“° News</h2>

      <div class="row">
        <div>
          <label>Title</label>
          <input id="newsTitle" placeholder="Headline..." />
        </div>
        <div>
          <label>Image URL (optional)</label>
          <input id="newsImage" placeholder="https://..." />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Body</label>
        <textarea id="newsBody" placeholder="News content..."></textarea>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <label class="muted"><input id="newsPublished" type="checkbox" /> Published</label>
        <button id="btnCreateNews">Create</button>
        <span id="createMsg" class="muted"></span>
      </div>

      <hr style="border:0;border-top:1px solid #222;margin:16px 0" />

      <div class="row">
        <div>
          <label>Search</label>
          <input id="searchQ" placeholder="Search title/body/author..." />
        </div>
        <div>
          <label>Published</label>
          <select id="filterPublished">
            <option value="all">All</option>
            <option value="true">Published</option>
            <option value="false">Drafts</option>
          </select>
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button id="btnSearch">Search</button>
        <button id="btnRefresh">Refresh</button>
        <span class="muted">Count:</span>
        <span id="newsCount" class="badge">0</span>
      </div>

      <div id="newsList"></div>
    </section>

    <!-- SPONSOR ANALYTICS (ADMIN ONLY) -->
    <section class="card">
      <h2>ðŸ’¼ Sponsor Performance (Admin)</h2>
      <p class="muted">This uses a locked admin endpoint. No public sponsor data is fetched here.</p>
      <button id="btnLoadSponsorAnalytics">Load Sponsor Analytics</button>
      <div id="sponsorStats" style="margin-top:12px"></div>
    </section>

    <!-- IMPORTANT: Stripe checkout should NOT accept raw priceId from client in admin.
         Use a server function that maps allowed plans. Kept out intentionally. -->

  </section>

  <script>
    const API = '/.netlify/functions'
    const TOKEN_KEY = 'tkfm_admin_token'

    const $ = (id) => document.getElementById(id)

    function escapeHTML(str) {
      if (typeof str !== 'string') return ''
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
    }

    function safeDate(d) {
      try {
        const dt = new Date(d)
        if (isNaN(dt.getTime())) return ''
        return dt.toLocaleString()
      } catch { return '' }
    }

    function token() {
      try { return localStorage.getItem(TOKEN_KEY) || '' } catch { return '' }
    }
    function setToken(t) {
      try { localStorage.setItem(TOKEN_KEY, t) } catch {}
    }
    function clearToken() {
      try { localStorage.removeItem(TOKEN_KEY) } catch {}
    }

    async function fetchJSON(url, opts = {}) {
      const res = await fetch(url, opts)
      const text = await res.text()
      let json = null
      try { json = text ? JSON.parse(text) : null } catch {}
      return { ok: res.ok, status: res.status, json }
    }

    function showDashboard(on) {
      $('loginCard').classList.toggle('hidden', on)
      $('dashboard').classList.toggle('hidden', !on)
    }

    function setTokenStatus(text, cls) {
      $('tokenStatus').textContent = text
      $('tokenStatus').className = cls
    }

    async function login() {
      $('loginMsg').textContent = 'Logging in...'

      const email = $('adminEmail').value.trim()
      const password = $('adminPassword').value

      // âœ… Correct endpoint name: admin-auth
      const { ok, json } = await fetchJSON(`${API}/admin-auth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      })

      if (!ok || !json?.token) {
        $('loginMsg').textContent = (json && (json.error || json.message)) || 'Login failed'
        return
      }

      setToken(json.token)
      $('loginMsg').textContent = 'Logged in'
      showDashboard(true)
      await verify()
      await refreshNews()
    }

    async function verify() {
      const t = token()
      if (!t) { setTokenStatus('missing', 'danger'); return }

      const { ok } = await fetchJSON(`${API}/admin-verify`, {
        method: 'GET',
        headers: { Authorization: `Bearer ${t}` }
      })

      if (!ok) {
        setTokenStatus('invalid', 'danger')
        clearToken()
        showDashboard(false)
        $('globalMsg').textContent = 'Token invalid â€” login again'
        return
      }

      setTokenStatus('valid', 'ok')
      $('globalMsg').textContent = 'Verified'
    }

    function logout() {
      clearToken()
      setTokenStatus('missing', 'danger')
      showDashboard(false)
      location.reload()
    }

    async function createNews() {
      const t = token()
      if (!t) return

      $('createMsg').textContent = 'Creating...'

      const title = $('newsTitle').value.trim()
      const body = $('newsBody').value.trim()
      const image_url = $('newsImage').value.trim()
      const published = $('newsPublished').checked

      const { ok, json } = await fetchJSON(`${API}/admin-create-news`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${t}` },
        body: JSON.stringify({ title, body, image_url: image_url || null, published })
      })

      if (!ok || !json?.ok) {
        $('createMsg').textContent = 'Create failed'
        return
      }

      $('createMsg').textContent = 'Created'
      $('newsTitle').value = ''
      $('newsBody').value = ''
      $('newsImage').value = ''
      $('newsPublished').checked = false
      await refreshNews()
    }

    async function refreshNews() {
      const t = token()
      if (!t) return

      const pub = $('filterPublished').value
      const url = `${API}/admin-list-news?limit=50&offset=0&published=${encodeURIComponent(pub)}`

      const { ok, json } = await fetchJSON(url, {
        method: 'GET',
        headers: { Authorization: `Bearer ${t}` }
      })

      if (!ok || !json?.ok) {
        $('globalMsg').textContent = 'Load news failed'
        return
      }

      renderNews(json.data || [])
      $('globalMsg').textContent = 'News loaded'
    }

    async function searchNews() {
      const t = token()
      if (!t) return

      const q = $('searchQ').value.trim()
      const pub = $('filterPublished').value

      if (!q) return refreshNews()

      const url = `${API}/admin-search-news?q=${encodeURIComponent(q)}&published=${encodeURIComponent(pub)}&limit=50`

      const { ok, json } = await fetchJSON(url, {
        method: 'GET',
        headers: { Authorization: `Bearer ${t}` }
      })

      if (!ok || !json?.ok) {
        $('globalMsg').textContent = 'Search failed'
        return
      }

      renderNews(json.data || [])
      $('globalMsg').textContent = `Found ${(json.data || []).length}`
    }

    function renderNews(items) {
      $('newsCount').textContent = String(items.length)

      if (!items.length) {
        $('newsList').innerHTML = '<p class="muted">No news posts.</p>'
        return
      }

      $('newsList').innerHTML = items.map(n => {
        const id = escapeHTML(n.id || '')
        const title = escapeHTML(n.title || 'Untitled')
        const body = escapeHTML(n.body || '')
        const author = escapeHTML(n.author || '')
        const created = safeDate(n.created_at)
        const pub = n.published === true

        return `
          <article>
            <h3>${title}</h3>
            <div class="meta">
              ${pub ? '<span class="badge ok">PUBLISHED</span>' : '<span class="badge warn">DRAFT</span>'}
              ${author ? ` â€¢ ${author}` : ''}
              ${created ? ` â€¢ ${created}` : ''}
            </div>
            <p>${body.replace(/\\n/g, '<br/>')}</p>
            <div class="toolbar">
              <button data-del="${id}">Delete</button>
              <button data-toggle="${id}" data-pub="${pub ? '1' : '0'}">${pub ? 'Unpublish' : 'Publish'}</button>
            </div>
          </article>
        `
      }).join('')

      // wire actions
      $('newsList').querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => deleteNews(btn.getAttribute('data-del')))
      })
      $('newsList').querySelectorAll('button[data-toggle]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-toggle')
          const next = btn.getAttribute('data-pub') !== '1'
          publishToggle(id, next)
        })
      })
    }

    async function publishToggle(id, published) {
      const t = token()
      if (!t) return

      const { ok, json } = await fetchJSON(`${API}/admin-publish-news`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${t}` },
        body: JSON.stringify({ id, published })
      })

      if (!ok || !json?.ok) {
        $('globalMsg').textContent = 'Publish toggle failed'
        return
      }

      await refreshNews()
    }

    async function deleteNews(id) {
      const t = token()
      if (!t) return
      if (!confirm('Delete this news post?')) return

      const { ok, json } = await fetchJSON(`${API}/admin-delete-news`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${t}` },
        body: JSON.stringify({ id })
      })

      if (!ok || !json?.ok) {
        $('globalMsg').textContent = 'Delete failed'
        return
      }

      await refreshNews()
    }

    async function loadSponsorAnalytics() {
      const t = token()
      if (!t) return

      $('sponsorStats').innerHTML = '<p class="muted">Loadingâ€¦</p>'

      const { ok, json } = await fetchJSON(`${API}/admin-sponsor-analytics`, {
        method: 'GET',
        headers: { Authorization: `Bearer ${t}` }
      })

      if (!ok || !json?.ok) {
        $('sponsorStats').innerHTML = '<p class="danger">Unauthorized / failed</p>'
        return
      }

      const items = json.data || []
      if (!items.length) {
        $('sponsorStats').innerHTML = '<p class="muted">No sponsors.</p>'
        return
      }

      $('sponsorStats').innerHTML = items.map(s => `
        <div class="card">
          <strong>${escapeHTML(s.name)}</strong><br/>
          Tier: ${escapeHTML(s.tier)}<br/>
          Impressions: ${s.impressions || 0}<br/>
          Clicks: ${s.clicks || 0}<br/>
          CTR: ${(s.ctr || 0)}%<br/>
          <span class="badge ${s.active ? 'ok' : 'warn'}">${s.active ? 'ACTIVE' : 'INACTIVE'}</span>
        </div>
      `).join('')
    }

    document.addEventListener('DOMContentLoaded', async () => {
      $('btnLogin').addEventListener('click', login)
      $('btnVerify').addEventListener('click', verify)
      $('btnLogout').addEventListener('click', logout)
      $('btnCreateNews').addEventListener('click', createNews)
      $('btnRefresh').addEventListener('click', refreshNews)
      $('btnSearch').addEventListener('click', searchNews)
      $('btnLoadSponsorAnalytics').addEventListener('click', loadSponsorAnalytics)

      if (token()) {
        showDashboard(true)
        await verify()
        await refreshNews()
      }
    })
  </script>
</body>
</html>

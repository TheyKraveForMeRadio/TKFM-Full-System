<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TKFM Admin â€” News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{background:#000;color:#fff;font-family:Arial;margin:0;padding:24px;max-width:1000px;margin:auto}
    .card{background:#111;border:1px solid #222;border-radius:14px;padding:16px;margin-bottom:16px}
    input,textarea,button{width:100%;padding:12px;border-radius:10px;border:1px solid #333;background:#0b0b0b;color:#fff}
    button{cursor:pointer;font-weight:bold;background:#1b1b1b}
    button:hover{border-color:#555}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#aaa;font-size:13px}
    .danger{background:#300;border-color:#600}
  </style>
</head>
<body>

<h1>ðŸ“° Admin â€” News</h1>

<div class="card">
  <h2>Create News</h2>
  <input id="title" placeholder="Title" />
  <textarea id="body" placeholder="Content" rows="6"></textarea>
  <button onclick="createNews()">Publish</button>
  <div id="msg" class="muted"></div>
</div>

<div class="card">
  <h2>Existing News</h2>
  <div id="list" class="muted">Loadingâ€¦</div>
</div>

<script>
const API = '/.netlify/functions'
const TOKEN_KEY = 'tkfm_admin_token'

function token() {
  const t = localStorage.getItem(TOKEN_KEY)
  if (!t) location.href = '/admin/login.html'
  return t
}

async function createNews() {
  msg.textContent = 'Publishingâ€¦'
  const res = await fetch(`${API}/admin-create-news`, {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${token()}`
    },
    body: JSON.stringify({
      title: title.value,
      body: body.value,
      published: true
    })
  })
  const j = await res.json()
  if (!res.ok) return msg.textContent = j.error || 'Failed'
  msg.textContent = 'Published'
  title.value = body.value = ''
  load()
}

async function load() {
  const res = await fetch(`${API}/admin-list-news`, {
    headers:{ 'Authorization':`Bearer ${token()}` }
  })
  const j = await res.json()
  if (!j.data) return list.textContent = 'No posts'
  list.innerHTML = j.data.map(n=>`
    <div class="card">
      <strong>${n.title}</strong>
      <p>${n.body.slice(0,200)}...</p>
      <button class="danger" onclick="del('${n.id}')">Delete</button>
    </div>
  `).join('')
}

async function del(id) {
  if (!confirm('Delete this post?')) return
  await fetch(`${API}/admin-delete-news`, {
    method:'DELETE',
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${token()}`
    },
    body: JSON.stringify({ id })
  })
  load()
}

load()
</script>

</body>
</html>

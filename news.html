<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>News | TKFM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background:#000; color:#fff; font-family: Arial, sans-serif; padding: 40px; }
    h1 { margin-bottom: 20px; }
    .muted { color:#aaa; }
    article { background:#111; padding:20px; margin-bottom:20px; border-radius:10px; border:1px solid #222; }
    article h2 { margin:0 0 10px; font-size: 20px; }
    .meta { font-size: 12px; color:#9aa; margin-bottom: 10px; }
    img { max-width: 100%; border-radius: 10px; margin: 10px 0; border:1px solid #222; }
    .error { background:#240; border:1px solid #500; padding:14px; border-radius:10px; }
  </style>
</head>
<body>

  <h1>TKFM News</h1>
  <p class="muted">Latest updates from the station.</p>

  <div id="news-list">
    <p class="muted">Loading news…</p>
  </div>

  <script>
    const API = "/.netlify/functions/public-get-news";

    function escapeHTML(str) {
      if (typeof str !== "string") return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function safeDate(d) {
      try {
        const dt = new Date(d);
        if (isNaN(dt.getTime())) return "";
        return dt.toLocaleDateString();
      } catch {
        return "";
      }
    }

    function safeImageUrl(url) {
      if (typeof url !== "string") return "";
      const u = url.trim();
      if (!u) return "";
      if (u.length > 500) return "";
      try {
        const parsed = new URL(u);
        if (parsed.protocol !== "https:" && parsed.hostname !== "localhost") return "";
        return parsed.toString();
      } catch {
        return "";
      }
    }

    async function loadNews() {
      const box = document.getElementById("news-list");
      if (!box) return;

      try {
        const res = await fetch(API + "?limit=20", { method: "GET" });
        if (!res.ok) throw new Error("bad_response");

        const json = await res.json();
        const items = Array.isArray(json?.data) ? json.data : [];

        if (!items.length) {
          box.innerHTML = `<p class="muted">No news posts yet.</p>`;
          return;
        }

        box.innerHTML = items.map(post => {
          const title = escapeHTML(post.title || "Untitled");
          const body = escapeHTML(post.body || "");
          const author = escapeHTML(post.author || "TKFM");
          const date = safeDate(post.created_at);
          const img = safeImageUrl(post.image_url);

          return `
            <article>
              <h2>${title}</h2>
              <div class="meta">By ${author}${date ? ` • ${date}` : ""}</div>
              ${img ? `<img src="${img}" alt="${title}" loading="lazy" />` : ""}
              <p>${body.replace(/\n/g, "<br/>")}</p>
            </article>
          `;
        }).join("");

      } catch {
        box.innerHTML = `
          <div class="error">
            <strong>News is temporarily unavailable.</strong><br/>
            <span class="muted">Please check back soon.</span>
          </div>
        `;
      }
    }

    document.addEventListener("DOMContentLoaded", loadNews);
  </script>

</body>
</html>

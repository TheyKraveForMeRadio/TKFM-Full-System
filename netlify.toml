# =========================
# BUILD CONFIG
# =========================
[build]
  base = "v2"
  command = "npm run build"
  publish = "dist"
  functions = "netlify/functions"

# =========================
# DEV CONFIG (Netlify Dev)
# =========================
[dev]
  command = "npm run dev"
  targetPort = 5173
  port = 8899
  framework = "vite"

# =========================
# FUNCTIONS CONFIG
# =========================
[functions]
  node_bundler = "esbuild"
  external_node_modules = [
    "stripe",
    "uuid",
    "jsonwebtoken",
    "@supabase/supabase-js",
    "cloudinary"
  ]

# =========================
# üîÅ AUTOPILOT CRONS
# =========================
[functions."expire-features"]
  schedule = "@daily"

[functions."auto-promote-feature"]
  schedule = "@hourly"

[functions."feature-revenue-engine"]
  schedule = "@hourly"

[functions."feature-notification-engine"]
  schedule = "@hourly"

# =========================
# üîí PRODUCTION HEADERS
# =========================

# ADMIN FUNCTIONS
[[headers]]
  for = "/.netlify/functions/admin-*"
  [headers.values]
    Access-Control-Allow-Origin = "https://tkfmradio.com"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Vary = "Origin"

# STAFF FUNCTIONS
[[headers]]
  for = "/.netlify/functions/staff-*"
  [headers.values]
    Access-Control-Allow-Origin = "https://tkfmradio.com"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Vary = "Origin"

# DJ FUNCTIONS
[[headers]]
  for = "/.netlify/functions/dj-*"
  [headers.values]
    Access-Control-Allow-Origin = "https://tkfmradio.com"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Vary = "Origin"

# STRIPE / CHECKOUT FUNCTIONS (FIXED)
[[headers]]
  for = "/.netlify/functions/create-*"
  [headers.values]
    Access-Control-Allow-Origin = "https://tkfmradio.com"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
    Access-Control-Allow-Methods = "POST, OPTIONS"
    Vary = "Origin"

# PUBLIC FUNCTIONS (SAFE TO OPEN)
[[headers]]
  for = "/.netlify/functions/public-*"
  [headers.values]
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Headers = "Content-Type"
    Access-Control-Allow-Methods = "GET, OPTIONS"

# FALLBACK FUNCTIONS (LOCKED)
[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Access-Control-Allow-Origin = "https://tkfmradio.com"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Vary = "Origin"

# =========================
# üß™ DEV-ONLY CORS OVERRIDES
# =========================
[context.dev]

  [[context.dev.headers]]
    for = "/.netlify/functions/admin-*"
    [context.dev.headers.values]
      Access-Control-Allow-Origin = "http://localhost:8899"
      Access-Control-Allow-Headers = "Content-Type, Authorization"
      Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
      Vary = "Origin"

  [[context.dev.headers]]
    for = "/.netlify/functions/staff-*"
    [context.dev.headers.values]
      Access-Control-Allow-Origin = "http://localhost:8899"
      Access-Control-Allow-Headers = "Content-Type, Authorization"
      Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
      Vary = "Origin"

  [[context.dev.headers]]
    for = "/.netlify/functions/dj-*"
    [context.dev.headers.values]
      Access-Control-Allow-Origin = "http://localhost:8899"
      Access-Control-Allow-Headers = "Content-Type, Authorization"
      Access-Control-Allow-Methods = "GET, POST, OPTIONS"
      Vary = "Origin"

  [[context.dev.headers]]
    for = "/.netlify/functions/create-*"
    [context.dev.headers.values]
      Access-Control-Allow-Origin = "http://localhost:8899"
      Access-Control-Allow-Headers = "Content-Type, Authorization"
      Access-Control-Allow-Methods = "POST, OPTIONS"
      Vary = "Origin"

  [[context.dev.headers]]
    for = "/.netlify/functions/*"
    [context.dev.headers.values]
      Access-Control-Allow-Origin = "http://localhost:8899"
      Access-Control-Allow-Headers = "Content-Type, Authorization"
      Access-Control-Allow-Methods = "GET, POST, OPTIONS"
      Vary = "Origin"

# =========================
# üîê STATIC SECURITY HEADERS
# =========================
[[headers]]
  for = "/*"
  [headers.values]
    X-Content-Type-Options = "nosniff"
    X-Frame-Options = "DENY"
    Referrer-Policy = "no-referrer"
    Permissions-Policy = "geolocation=()"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

# =========================
# ROUTES / ALIASES
# =========================
[[redirects]]
  from = "/dj"
  to = "/dj.html"
  status = 200

[[redirects]]
  from = "/dj/upload"
  to = "/dj/upload.html"
  status = 200

[[redirects]]
  from = "/admin"
  to = "/admin/login.html"
  status = 200

[[redirects]]
  from = "/admin/news"
  to = "/admin/news.html"
  status = 200

[[redirects]]
  from = "/sponsors"
  to = "/sponsors.html"
  status = 200

[[redirects]]
  from = "/news"
  to = "/news.html"
  status = 200

[[redirects]]
  from = "/submit"
  to = "/submit.html"
  status = 200

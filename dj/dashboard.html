<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DJ Dashboard | TKFM</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{background:#000;color:#fff;font-family:Arial,sans-serif;margin:0;padding:40px 20px}
    .wrap{max-width:980px;margin:auto}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .card{background:#111;border:1px solid #222;border-radius:16px;padding:18px;margin:16px 0}
    button{padding:10px 14px;border-radius:10px;border:1px solid #333;background:#1b1b1b;color:#fff;font-weight:700;cursor:pointer}
    button:hover{border-color:#555}
    a{color:#ff00e6;text-decoration:none}
    a:hover{text-decoration:underline}
    .muted{color:#aaa;font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .item{background:#0b0b0b;border:1px solid #222;border-radius:14px;padding:14px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 style="margin:0">üìÄ DJ Dashboard</h1>
        <div class="muted" id="who"></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a href="/dj/upload.html"><button type="button">‚¨ÜÔ∏è Upload Mixtape</button></a>
        <button id="logout" type="button">Logout</button>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-top:0">Your Mixtapes (Public List)</h2>
      <div id="list" class="muted">Loading‚Ä¶</div>
    </div>
  </div>

  <script>
    const API = '/.netlify/functions'
    const TOKEN_KEY = 'tkfm_dj_token'
    const token = localStorage.getItem(TOKEN_KEY)

    if (!token) location.href = '/dj/login.html'

    document.getElementById('logout').addEventListener('click', async () => {
      try { await fetch(`${API}/dj-logout`, { method:'POST' }) } catch {}
      localStorage.removeItem(TOKEN_KEY)
      location.href = '/dj/login.html'
    })

    async function load() {
      const list = document.getElementById('list')
      try {
        const res = await fetch(`${API}/public-get-mixtapes`)
        const data = await res.json()

        const arr = Array.isArray(data?.data) ? data.data : (Array.isArray(data) ? data : [])
        if (!arr.length) { list.textContent = 'No mixtapes yet.'; return }

        list.innerHTML = `
          <div class="grid">
            ${arr.slice(0, 30).map(m => `
              <div class="item">
                <strong>${escapeHTML(m.title || 'Untitled')}</strong><br/>
                <span class="muted">DJ: ${escapeHTML(m.djName || m.dj || '‚Äî')}</span><br/>
                ${m.audioUrl ? `<audio controls src="${escapeAttr(m.audioUrl)}" style="width:100%;margin-top:8px"></audio>` : ''}
              </div>
            `).join('')}
          </div>
        `
      } catch (e) {
        list.textContent = 'Error loading mixtapes.'
      }
    }

    function escapeHTML(s){ s=String(s??''); return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }
    function escapeAttr(s){ s=String(s??''); return s.replace(/"/g,'&quot;') }

    load()
  </script>
</body>
</html>


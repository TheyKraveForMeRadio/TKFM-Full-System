<!doctype html>
<html lang="en">
<head>
  <meta name="tkfm-access" content="owner" />
  <script src="/js/access-gates.js" defer></script>

  <meta charset="utf-8" />
  <title>TKFM Autopilot Engine ‚Äî Weighted Rotation Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="TKFM Autopilot Engine builds weighted rotation packs from artist uploads, label decisions and mixtape projects for They Krave For Me Radio." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/js/logo-check.js" defer></script>
  <style>
    body{
      background:#020617;
      background-image:
        radial-gradient(circle at 10% 0,rgba(56,189,248,0.18),transparent 55%),
        radial-gradient(circle at 90% 0,rgba(236,72,153,0.18),transparent 55%),
        radial-gradient(circle at 50% 100%,rgba(34,211,238,0.16),transparent 55%);
    }
    ::-webkit-scrollbar{height:6px;width:6px;}
    ::-webkit-scrollbar-thumb{background:#334155;border-radius:999px;}
    .glass{
      background-color:rgba(15,23,42,0.92);
      backdrop-filter:blur(24px);
    }
  </style>
<script src="/js/tkfm-fx.js"></script>
</head>
<body data-requires="creator_pass_monthly" data-gate-title="üîí TKFM Creator Access Required" data-gate-message="Upgrade to Creator Pass to unlock this page." class="text-slate-50 min-h-screen flex flex-col" data-tkfm-theme="radio">
<script>window.TKFM_FX&&TKFM_FX.mount({ theme: 'radio' });</script>

  <!-- NAV -->
  <header class="w-full border-b border-slate-800/80 bg-black/70 backdrop-blur-xl sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <a href="index.html" class="flex items-center gap-3">
        <img src="/tkfm-radio-logo.png" alt="TKFM Radio" class="h-9 w-auto object-contain" />
        <div class="leading-tight">
          <div class="text-[0.6rem] uppercase tracking-[0.35em] text-slate-400">
            They Krave For Me Radio
          </div>
          <div class="text-sm font-semibold">
            TKFM <span class="text-cyan-300">Autopilot Engine</span>
          </div>
        </div>
      </a>
      <nav class="ml-auto flex flex-wrap gap-2 text-[0.7rem] uppercase tracking-[0.22em]">
        <a href="radio-hub.html" class="px-3 py-1 rounded-full border border-slate-700/80 bg-slate-950/80 text-slate-100 flex items-center gap-1">
          <span>üìª</span><span>Radio Hub</span>
        </a>
        <a href="ai-dj-engine.html" class="px-3 py-1 rounded-full border border-pink-400/80 bg-pink-400/10 text-pink-200 flex items-center gap-1">
          <span>ü§ñ</span><span>AI DJ</span>
        </a>
        <a href="label-hub.html" class="px-3 py-1 rounded-full border border-yellow-400/80 bg-yellow-400/10 text-yellow-200 flex items-center gap-1">
          <span>üèõ</span><span>Label Hub</span>
        </a>
        <a href="dj-mixtape-hosting.html" class="px-3 py-1 rounded-full border border-purple-400/80 bg-purple-400/10 text-purple-200 flex items-center gap-1">
          <span>üî•</span><span>Mixtape Hosting</span>
        </a>
        <a href="tkfm-dev-console.html" class="px-3 py-1 rounded-full border border-emerald-400/80 bg-emerald-400/10 text-emerald-200 flex items-center gap-1">
          <span>üß™</span><span>Dev Console</span>
        </a>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1">
    <section class="max-w-6xl mx-auto px-4 pt-8 pb-12 space-y-7">

      <!-- HERO + SNAPSHOT -->
      <div class="flex flex-col lg:flex-row gap-6 items-start">
        <!-- HERO -->
        <div class="flex-1 space-y-3">
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-cyan-400/80 bg-cyan-400/10 text-[0.7rem] uppercase tracking-[0.3em] text-cyan-200">
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
            Autopilot ‚Ä¢ Weighted Rotation Builder
          </div>

          <h1 class="text-3xl md:text-4xl font-extrabold leading-tight">
            Build a <span class="text-cyan-300 drop-shadow-[0_0_26px_rgba(56,189,248,0.9)]">smart rotation pack</span>
            from uploads, label calls & mixtape projects.
          </h1>

          <p class="text-sm md:text-base text-slate-100/90 max-w-2xl">
            This engine reads <span class="font-mono text-cyan-300 text-[0.8rem]">tkfm_artist_uploads</span>,
            <span class="font-mono text-cyan-300 text-[0.8rem]">mixtapeOrders</span> and your label decisions
            to build a **weighted pack** saved as
            <span class="font-mono text-cyan-300 text-[0.8rem]">tkfm_autopilot_last_pack</span>
            for TKFM Radio + the AI DJ Engine.
          </p>

          <p class="text-[0.78rem] text-slate-400 max-w-xl">
            Dev mode only: everything here writes to <span class="font-mono text-cyan-300 text-[0.75rem]">localStorage</span>.
            In production this pattern can sit on top of a real DB + cron.
          </p>

          <div class="flex flex-wrap gap-3 text-[0.8rem] mt-2">
            <button id="ap-generate" class="px-4 py-2 rounded-full border border-emerald-400/80 bg-emerald-400/10 text-emerald-100 font-medium uppercase tracking-[0.22em]">
              Generate Pack
            </button>
            <button id="ap-preview" class="px-4 py-2 rounded-full border border-sky-400/80 bg-sky-400/10 text-sky-100 uppercase tracking-[0.22em]">
              Preview Selection
            </button>
            <a href="radio-hub.html" class="px-4 py-2 rounded-full border border-slate-600/80 bg-slate-900/90 text-slate-100 flex items-center gap-2">
              <span>üìª</span><span>Open Radio Hub</span>
            </a>
          </div>
        </div>

        <!-- SNAPSHOT CARD -->
        <aside class="w-full max-w-sm rounded-3xl border border-slate-800 glass relative overflow-hidden">
          <div class="pointer-events-none absolute -inset-20 opacity-40 blur-3xl bg-[conic-gradient(from_120deg,_#22d3ee,_#a855f7,_#ec4899,_#22d3ee)]"></div>
          <div class="relative p-4 space-y-3 text-sm">
            <div class="flex items-center justify-between gap-3">
              <div>
                <p class="text-[0.7rem] uppercase tracking-[0.3em] text-slate-400 mb-1">
                  Autopilot Snapshot (This Device)
                </p>
                <p class="text-xs text-slate-100">
                  Reads the last pack + core TKFM keys.
                </p>
              </div>
              <button id="ap-refresh" class="px-2.5 py-1 rounded-full border border-cyan-400/80 bg-cyan-400/10 text-[0.65rem] uppercase tracking-[0.22em] text-cyan-200">
                Refresh
              </button>
            </div>

            <div class="grid grid-cols-3 gap-3 text-xs">
              <div>
                <p class="text-slate-300 mb-0.5">Artist Uploads</p>
                <p id="ap-uploads" class="text-lg font-bold text-cyan-200">0</p>
              </div>
              <div>
                <p class="text-slate-300 mb-0.5">Mixtape Orders</p>
                <p id="ap-orders" class="text-lg font-bold text-cyan-200">0</p>
              </div>
              <div>
                <p class="text-slate-300 mb-0.5">Fan Profiles</p>
                <p id="ap-fans" class="text-lg font-bold text-cyan-200">0</p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3 text-xs">
              <div>
                <p class="text-slate-300 mb-0.5">Last Pack</p>
                <p id="ap-pack-summary" class="text-sm font-semibold text-emerald-200">None</p>
              </div>
              <div>
                <p class="text-slate-300 mb-0.5">Created</p>
                <p id="ap-pack-date" class="text-[0.7rem] text-slate-200">‚Äî</p>
              </div>
            </div>

            <p class="text-[0.72rem] text-slate-300">
              Key: <span class="font-mono text-cyan-300 text-[0.7rem]">tkfm_autopilot_last_pack</span> +
              updates <span class="font-mono text-cyan-300 text-[0.7rem]">tkfm_radio_state</span> &
              <span class="font-mono text-cyan-300 text-[0.7rem]">tkfm_radio_now_playing</span>.
            </p>
          </div>
        </aside>
      </div>

      <!-- CONTROL PANEL -->
      <section class="grid gap-4 lg:grid-cols-[minmax(0,1.2fr)_minmax(0,0.9fr)]">
        <!-- Left: Weights & Modes -->
        <div class="rounded-3xl border border-slate-800 glass p-4 md:p-5 text-sm space-y-3">
          <header class="flex items-center justify-between gap-2">
            <div>
              <p class="text-[0.7rem] uppercase tracking-[0.3em] text-slate-400">
                Rotation Controls
              </p>
              <h2 class="text-sm font-semibold text-slate-50">
                Define how Autopilot treats your ecosystem.
              </h2>
            </div>
            <span class="text-xl">‚öô</span>
          </header>

          <!-- Mode + Pack Size -->
          <div class="grid gap-3 md:grid-cols-3 text-[0.8rem]">
            <label class="space-y-1">
              <span class="text-slate-300">Show Mode</span>
              <select id="ap-mode" class="w-full rounded-lg bg-slate-950/90 border border-slate-700/80 px-2 py-1.5">
                <option value="night-drive">Night Drive</option>
                <option value="club-energy">Club Energy</option>
                <option value="label-focus">Label Focus</option>
                <option value="mixtape-premiere">Mixtape Premiere</option>
                <option value="balanced">Balanced Mix</option>
              </select>
            </label>
            <label class="space-y-1">
              <span class="text-slate-300">Pack Size</span>
              <select id="ap-pack-size" class="w-full rounded-lg bg-slate-950/90 border border-slate-700/80 px-2 py-1.5">
                <option value="10">10 Records</option>
                <option value="15">15 Records</option>
                <option value="20">20 Records</option>
                <option value="30">30 Records</option>
              </select>
            </label>
            <label class="space-y-1">
              <span class="text-slate-300">Max Per Artist</span>
              <select id="ap-max-per-artist" class="w-full rounded-lg bg-slate-950/90 border border-slate-700/80 px-2 py-1.5">
                <option value="0">No limit</option>
                <option value="2">2 per artist</option>
                <option value="3">3 per artist</option>
              </select>
            </label>
          </div>

          <!-- Weights -->
          <div class="grid gap-3 md:grid-cols-2 mt-1 text-[0.8rem]">
            <div class="space-y-1">
              <p class="text-slate-300">Weight Rules</p>
              <div class="flex flex-col gap-1.5">
                <label class="inline-flex items-center gap-2">
                  <input id="ap-w-featured" type="checkbox" class="rounded border-slate-600 bg-slate-950" checked />
                  <span class="text-slate-200">Boost <span class="font-semibold text-emerald-300">featured</span> uploads</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input id="ap-w-accepted" type="checkbox" class="rounded border-slate-600 bg-slate-950" checked />
                  <span class="text-slate-200">Boost uploads with <span class="font-semibold">accepted / label</span> status</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input id="ap-w-mixtape" type="checkbox" class="rounded border-slate-600 bg-slate-950" checked />
                  <span class="text-slate-200">Include &amp; boost <span class="font-semibold text-purple-300">mixtape projects</span></span>
                </label>
              </div>
            </div>

            <div class="space-y-1">
              <p class="text-slate-300">Tier Emphasis</p>
              <p class="text-[0.75rem] text-slate-400">
                Higher tiers = more weight. These multipliers stack with the base rules above.
              </p>
              <div class="grid grid-cols-3 gap-2">
                <label class="space-y-0.5">
                  <span class="text-[0.75rem] text-slate-300">Starter</span>
                  <select id="ap-m-starter" class="w-full rounded bg-slate-950/90 border border-slate-700/80 px-2 py-1.5 text-[0.75rem]">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.5">1.5x</option>
                  </select>
                </label>
                <label class="space-y-0.5">
                  <span class="text-[0.75rem] text-slate-300">Pro</span>
                  <select id="ap-m-pro" class="w-full rounded bg-slate-950/90 border border-slate-700/80 px-2 py-1.5 text-[0.75rem]">
                    <option value="1">1x</option>
                    <option value="1.5" selected>1.5x</option>
                    <option value="2">2x</option>
                  </select>
                </label>
                <label class="space-y-0.5">
                  <span class="text-[0.75rem] text-slate-300">Elite</span>
                  <select id="ap-m-elite" class="w-full rounded bg-slate-950/90 border border-slate-700/80 px-2 py-1.5 text-[0.75rem]">
                    <option value="1.5">1.5x</option>
                    <option value="2" selected>2x</option>
                    <option value="3">3x</option>
                  </select>
                </label>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="grid gap-3 md:grid-cols-2 mt-2 text-[0.8rem]">
            <div class="space-y-1">
              <p class="text-slate-300">Filter</p>
              <div class="flex flex-col gap-1.5">
                <label class="inline-flex items-center gap-2">
                  <input id="ap-filter-city" type="checkbox" class="rounded border-slate-600 bg-slate-950" />
                  <span class="text-slate-200">Focus on a single city</span>
                </label>
                <input id="ap-filter-city-input" class="w-full rounded-lg bg-slate-950/90 border border-slate-700/80 px-2 py-1.5 text-[0.8rem]" placeholder="Example: Detroit, MI" />
              </div>
            </div>

            <div class="space-y-1">
              <p class="text-slate-300">Label Focus Extras</p>
              <div class="flex flex-col gap-1.5">
                <label class="inline-flex items-center gap-2">
                  <input id="ap-only-labeled" type="checkbox" class="rounded border-slate-600 bg-slate-950" />
                  <span class="text-slate-200">Prefer uploads with label / spotlight status</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input id="ap-add-news" type="checkbox" class="rounded border-slate-600 bg-slate-950" />
                  <span class="text-slate-200">Drop a system note into <span class="font-mono text-cyan-300 text-[0.75rem]">tkfm_news_manual</span></span>
                </label>
              </div>
            </div>
          </div>

          <p id="ap-status" class="text-[0.75rem] text-emerald-300 mt-1"></p>
        </div>

        <!-- Right: Candidate Summary -->
        <aside class="rounded-3xl border border-slate-800 glass p-4 md:p-5 text-sm space-y-3">
          <header class="flex items-center justify-between gap-2">
            <div>
              <p class="text-[0.7rem] uppercase tracking-[0.3em] text-slate-400">
                Candidate Pool
              </p>
              <h2 class="text-sm font-semibold text-slate-50">
                What Autopilot can pull from.
              </h2>
            </div>
            <span class="text-xl">üéö</span>
          </header>

          <p class="text-[0.8rem] text-slate-300">
            Built from:
            <span class="font-mono text-cyan-300 text-[0.75rem]">tkfm_artist_uploads</span> +
            <span class="font-mono text-cyan-300 text-[0.75rem]">mixtapeOrders</span>.
            Use the Dev Console‚Äôs **Load Demo Data** if you need a quick test.
          </p>

          <div id="ap-candidates-empty" class="text-[0.8rem] text-slate-400">
            No eligible records yet. Add uploads, mixtape orders or load demo data first.
          </div>

          <div id="ap-candidates" class="hidden space-y-2 text-[0.78rem] max-h-64 overflow-y-auto">
            <!-- Filled by JS -->
          </div>

          <p class="text-[0.7rem] text-slate-400">
            Weights are shown as a hint. Final pack uses **weighted random without replacement** on each generate.
          </p>
        </aside>
      </section>

      <!-- PREVIEW PANEL -->
      <section class="rounded-3xl border border-slate-800 glass p-4 md:p-5 text-sm space-y-3">
        <header class="flex items-center justify-between gap-2">
          <div>
            <p class="text-[0.7rem] uppercase tracking-[0.3em] text-slate-400">
              Pack Preview
            </p>
            <h2 class="text-sm font-semibold text-slate-50">
              See what you‚Äôre about to hand the DJ.
            </h2>
          </div>
          <span class="text-xl">üìº</span>
        </header>

        <div id="ap-preview-empty" class="text-[0.8rem] text-slate-400">
          Click <span class="text-emerald-300 font-semibold">Preview Selection</span> or
          <span class="text-emerald-300 font-semibold">Generate Pack</span> to see the current build.
        </div>

        <div id="ap-preview-list" class="hidden grid gap-2 md:grid-cols-2 lg:grid-cols-3 text-[0.78rem]">
          <!-- Filled by JS -->
        </div>
      </section>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="border-t border-slate-800/80 bg-black/70">
    <div class="max-w-6xl mx-auto px-4 py-4 text-[0.7rem] text-slate-400 flex flex-wrap gap-3 items-center">
      <span>¬© 2025 TKFM ‚Äî Autopilot Engine v2.</span>
      <span class="opacity-80">
        Builds tkfm_autopilot_last_pack and updates radio state for TKFM Radio & AI DJ Engine.
      </span>
    </div>
  </footer>

  <script>
    // ---------- helpers ----------
    function apSafeParse(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch (e) {
        console.warn('Autopilot parse fail', key, e);
        return fallback;
      }
    }
    function apArray(key) {
      const v = apSafeParse(key, []);
      return Array.isArray(v) ? v : [];
    }
    function apPrettyDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '';
      return d.toLocaleString();
    }
    function apEscape(str) {
      return String(str || '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    function apSetStatus(msg, isError) {
      const el = document.getElementById('ap-status');
      if (!msg) { el.textContent = ''; return; }
      el.textContent = msg;
      el.style.color = isError ? '#fca5a5' : '#6ee7b7';
    }

    function apBuildCandidates(options) {
      const uploads = apArray('tkfm_artist_uploads');
      const orders = apArray('mixtapeOrders');
      const { includeMixtapes, focusCity, onlyLabel } = options || {};

      const candidates = [];

      // Artist uploads
      uploads.forEach((u, idx) => {
        if (!u) return;
        const city = u.city || '';
        if (focusCity && city && !city.toLowerCase().includes(focusCity.toLowerCase())) {
          return;
        }

        const status = (u.status || '').toLowerCase();
        const isFeatured = status === 'featured';
        const isLabelish = status === 'accepted' || status === 'label' || status === 'elite';

        if (onlyLabel && !isFeatured && !isLabelish) return;

        let tier = 'Standard';
        if (isFeatured) tier = 'Featured';
        if (isLabelish) tier = 'Label';

        candidates.push({
          sourceType: 'upload',
          id: u.id || ('upload-' + idx),
          artistName: u.artistName || u.artist || 'Unknown Artist',
          trackTitle: u.trackTitle || u.title || 'Untitled Record',
          city: city,
          status: u.status || '',
          tier,
          tag: u.tag || '',
          sourceKey: 'tkfm_artist_uploads',
          raw: u
        });
      });

      // Mixtape orders as "projects"
      if (includeMixtapes) {
        orders.forEach((o, idx) => {
          if (!o) return;
          const city = o.city || '';
          if (focusCity && city && !city.toLowerCase().includes(focusCity.toLowerCase())) {
            return;
          }
          const tier = o.tier || 'Starter';
          const status = o.status || '';
          candidates.push({
            sourceType: 'mixtape',
            id: o.id || ('mix-' + idx),
            artistName: o.clientName || 'Mixtape Client',
            trackTitle: o.projectTitle || 'Mixtape Project',
            city: city,
            status,
            tier,
            tag: 'Mixtape ' + tier,
            sourceKey: 'mixtapeOrders',
            raw: o
          });
        });
      }

      return candidates;
    }

    function apComputeWeight(item, opts) {
      let w = 1;

      const status = (item.status || '').toLowerCase();
      const tier = (item.tier || '').toLowerCase();

      if (opts.boostFeatured && status === 'featured') w += 1.5;
      if (opts.boostAccepted && (status === 'accepted' || status === 'label' || status === 'elite')) w += 1;

      if (item.sourceType === 'mixtape' && opts.boostMixtape) {
        w += 1;
      }

      // tier multipliers (based on mixtape tier if present)
      if (tier.includes('starter')) w *= opts.mStarter;
      if (tier.includes('pro'))     w *= opts.mPro;
      if (tier.includes('elite'))   w *= opts.mElite;

      // mode tweaks
      const mode = opts.mode;
      if (mode === 'night-drive') {
        if (tier.includes('featured') || tier.includes('elite')) w *= 1.2;
      } else if (mode === 'club-energy') {
        if (item.sourceType === 'mixtape') w *= 1.3;
      } else if (mode === 'label-focus') {
        if (status === 'accepted' || status === 'label' || status === 'elite') w *= 1.4;
      } else if (mode === 'mixtape-premiere') {
        if (item.sourceType === 'mixtape') w *= 1.6;
      }

      if (w < 0.1) w = 0.1;
      return w;
    }

    function apWeightedSample(items, size, weightFn, maxPerArtist) {
      const pool = items.map(i => ({ ...i }));
      const out = [];
      const countsByArtist = {};

      while (out.length < size && pool.length > 0) {
        let total = 0;
        const weights = pool.map(it => {
          const w = weightFn(it);
          total += w;
          return w;
        });
        if (!total || total <= 0) break;

        let r = Math.random() * total;
        let idx = 0;
        for (; idx < weights.length; idx++) {
          r -= weights[idx];
          if (r <= 0) break;
        }
        if (idx >= pool.length) idx = pool.length - 1;

        const chosen = pool[idx];
        const key = (chosen.artistName || '').toLowerCase() || chosen.id;
        const allowedLimit = maxPerArtist || 0;

        if (allowedLimit > 0) {
          const current = countsByArtist[key] || 0;
          if (current >= allowedLimit) {
            pool.splice(idx, 1);
            continue;
          }
          countsByArtist[key] = current + 1;
        }

        out.push(chosen);
        pool.splice(idx, 1);
      }

      return out;
    }

    function apRenderSnapshot() {
      const uploads = apArray('tkfm_artist_uploads');
      const orders = apArray('mixtapeOrders');
      const fans   = apArray('tkfm_fan_profiles');
      const pack   = apSafeParse('tkfm_autopilot_last_pack', null);

      document.getElementById('ap-uploads').textContent = uploads.length;
      document.getElementById('ap-orders').textContent  = orders.length;
      document.getElementById('ap-fans').textContent    = fans.length;

      const sumEl = document.getElementById('ap-pack-summary');
      const dateEl = document.getElementById('ap-pack-date');

      if (!pack) {
        sumEl.textContent = 'None';
        dateEl.textContent = '‚Äî';
        return;
      }

      const tracks = Array.isArray(pack.tracks) ? pack.tracks.length :
                     Array.isArray(pack.items)  ? pack.items.length  :
                     pack.size || 0;

      const mode = pack.mode || pack.profile || 'default';
      sumEl.textContent = tracks
        ? mode + ' ‚Ä¢ ' + tracks + ' track' + (tracks !== 1 ? 's' : '')
        : mode;

      dateEl.textContent = apPrettyDate(pack.createdAt || pack.timestamp) || '‚Äî';
    }

    function apRenderCandidates(cands, weightOpts) {
      const wrap = document.getElementById('ap-candidates');
      const empty = document.getElementById('ap-candidates-empty');

      if (!cands.length) {
        wrap.classList.add('hidden');
        empty.classList.remove('hidden');
        wrap.innerHTML = '';
        return;
      }

      empty.classList.add('hidden');
      wrap.classList.remove('hidden');

      wrap.innerHTML = cands.slice(0, 40).map(item => {
        const w = apComputeWeight(item, weightOpts);
        const tier = item.tier || '';
        const city = item.city || '';
        const src  = item.sourceType === 'mixtape' ? 'Mixtape' : 'Upload';
        const status = item.status || '';
        return (
          '<div class="rounded-2xl border border-slate-800 bg-slate-950/90 px-3 py-2 flex flex-col gap-1">' +
            '<div class="flex items-center justify-between gap-2">' +
              '<div class="min-w-0">' +
                '<p class="text-[0.78rem] font-semibold truncate">' + apEscape(item.trackTitle) + '</p>' +
                '<p class="text-[0.7rem] text-slate-300 truncate">' + apEscape(item.artistName) + (city ? ' ‚Ä¢ ' + apEscape(city) : '') + '</p>' +
              '</div>' +
              '<span class="text-[0.65rem] px-2 py-0.5 rounded-full border border-slate-700/80 bg-slate-900/90 text-slate-200">' +
                apEscape(src) +
              '</span>' +
            '</div>' +
            '<div class="flex items-center justify-between gap-2 text-[0.7rem] text-slate-400">' +
              '<span class="truncate">' +
                (tier ? 'Tier: ' + apEscape(tier) : 'Tier: n/a') +
                (status ? ' ‚Ä¢ ' + apEscape(status) : '') +
              '</span>' +
              '<span class="text-cyan-300">w‚âà' + w.toFixed(2) + '</span>' +
            '</div>' +
          '</div>'
        );
      }).join('');

      if (cands.length > 40) {
        wrap.innerHTML +=
          '<p class="text-[0.7rem] text-slate-400 mt-1">+' + (cands.length - 40) + ' more in pool‚Ä¶</p>';
      }
    }

    function apRenderPreview(list) {
      const empty = document.getElementById('ap-preview-empty');
      const grid  = document.getElementById('ap-preview-list');

      if (!list || !list.length) {
        empty.classList.remove('hidden');
        grid.classList.add('hidden');
        grid.innerHTML = '';
        return;
      }

      empty.classList.add('hidden');
      grid.classList.remove('hidden');

      grid.innerHTML = list.map((item, idx) => {
        const city = item.city || '';
        const src  = item.sourceType === 'mixtape' ? 'Mixtape' : 'Upload';
        const tier = item.tier || '';
        return (
          '<div class="rounded-2xl border border-slate-800 bg-slate-950/90 px-3 py-2 flex flex-col gap-1">' +
            '<div class="flex items-center justify-between gap-2">' +
              '<span class="text-[0.7rem] text-slate-500">#' + (idx + 1) + '</span>' +
              '<span class="text-[0.65rem] px-2 py-0.5 rounded-full border border-slate-700/80 bg-slate-900/90 text-slate-200">' +
                apEscape(src) +
              '</span>' +
            '</div>' +
            '<p class="text-[0.8rem] font-semibold truncate">' + apEscape(item.trackTitle) + '</p>' +
            '<p class="text-[0.75rem] text-slate-300 truncate">' + apEscape(item.artistName) + (city ? ' ‚Ä¢ ' + apEscape(city) : '') + '</p>' +
            '<p class="text-[0.7rem] text-slate-400 truncate">' +
              (tier ? 'Tier: ' + apEscape(tier) : 'Tier: n/a') +
              (item.tag ? ' ‚Ä¢ ' + apEscape(item.tag) : '') +
            '</p>' +
          '</div>'
        );
      }).join('');
    }

    function apAddSystemNews(mode, size) {
      try {
        const existing = apSafeParse('tkfm_news_manual', []);
        const arr = Array.isArray(existing) ? existing : [];
        const now = new Date().toISOString();
        arr.push({
          title: 'New Autopilot pack generated',
          subtitle: 'Mode: ' + mode + ' ‚Ä¢ Size: ' + size,
          body: 'TKFM Autopilot Engine just built a fresh rotation pack based on current uploads, label signals and mixtape projects.',
          channel: 'system',
          city: '',
          actor: 'Autopilot Engine',
          tags: ['autopilot','rotation','system'],
          createdAt: now
        });
        localStorage.setItem('tkfm_news_manual', JSON.stringify(arr));
      } catch (e) {
        console.warn('Failed to add system news', e);
      }
    }

    function apSavePack(mode, profile, selected) {
      const now = new Date().toISOString();
      const tracks = selected.map(item => ({
        id: item.id,
        artistName: item.artistName,
        trackTitle: item.trackTitle,
        city: item.city || '',
        tier: item.tier || '',
        tag: item.tag || '',
        source: item.sourceKey || '',
        sourceType: item.sourceType || '',
      }));

      const pack = {
        mode,
        profile,
        createdAt: now,
        tracks
      };

      localStorage.setItem('tkfm_autopilot_last_pack', JSON.stringify(pack));

      const radioState = {
        index: 0,
        updatedAt: now
      };
      const nowPlaying = {
        index: 0,
        track: tracks[0] || null,
        updatedAt: now
      };
      localStorage.setItem('tkfm_radio_state', JSON.stringify(radioState));
      localStorage.setItem('tkfm_radio_now_playing', JSON.stringify(nowPlaying));

      return pack;
    }

    document.addEventListener('DOMContentLoaded', function () {
      const btnRefresh  = document.getElementById('ap-refresh');
      const btnGenerate = document.getElementById('ap-generate');
      const btnPreview  = document.getElementById('ap-preview');

      const modeSel     = document.getElementById('ap-mode');
      const sizeSel     = document.getElementById('ap-pack-size');
      const maxArtistSel= document.getElementById('ap-max-per-artist');

      const wFeatured   = document.getElementById('ap-w-featured');
      const wAccepted   = document.getElementById('ap-w-accepted');
      const wMixtape    = document.getElementById('ap-w-mixtape');

      const mStarterSel = document.getElementById('ap-m-starter');
      const mProSel     = document.getElementById('ap-m-pro');
      const mEliteSel   = document.getElementById('ap-m-elite');

      const filterCityChk   = document.getElementById('ap-filter-city');
      const filterCityInput = document.getElementById('ap-filter-city-input');
      const onlyLabelChk    = document.getElementById('ap-only-labeled');
      const addNewsChk      = document.getElementById('ap-add-news');

      function getWeightOptions() {
        return {
          mode: modeSel.value,
          boostFeatured: !!wFeatured.checked,
          boostAccepted: !!wAccepted.checked,
          boostMixtape: !!wMixtape.checked,
          mStarter: parseFloat(mStarterSel.value || '1') || 1,
          mPro: parseFloat(mProSel.value || '1') || 1,
          mElite: parseFloat(mEliteSel.value || '1') || 1
        };
      }

      function getFilterOptions() {
        const focusCity = filterCityChk.checked
          ? (filterCityInput.value || '').trim()
          : '';
        return {
          includeMixtapes: !!wMixtape.checked,
          focusCity: focusCity || '',
          onlyLabel: !!onlyLabelChk.checked
        };
      }

      function buildPool() {
        const filterOpts = getFilterOptions();
        const weightOpts = getWeightOptions();
        const cands = apBuildCandidates(filterOpts);
        apRenderCandidates(cands, weightOpts);
        return { cands, weightOpts, filterOpts };
      }

      function previewPack() {
        apSetStatus('', false);
        const { cands, weightOpts } = buildPool();

        if (!cands.length) {
          apSetStatus('No eligible records in pool. Add uploads / mixtape orders or load demo data.', true);
          apRenderPreview([]);
          return;
        }

        const packSize = parseInt(sizeSel.value || '10', 10) || 10;
        const maxPer = parseInt(maxArtistSel.value || '0', 10) || 0;

        const selected = apWeightedSample(
          cands,
          Math.min(packSize, cands.length),
          (item) => apComputeWeight(item, weightOpts),
          maxPer
        );
        apRenderPreview(selected);
        apSetStatus('Previewed ' + selected.length + ' record(s) for the current settings.', false);
        return selected;
      }

      function generatePack() {
        apSetStatus('', false);
        const selected = previewPack();
        if (!selected || !selected.length) return;

        const mode = modeSel.value;
        let profile = 'TKFM Rotation ‚Äî ' + mode;

        if (mode === 'night-drive')      profile = 'TKFM Night Drive';
        if (mode === 'club-energy')      profile = 'TKFM Club Energy';
        if (mode === 'label-focus')      profile = 'TKFM Label Focus';
        if (mode === 'mixtape-premiere') profile = 'TKFM Mixtape Premiere';

        const pack = apSavePack(mode, profile, selected);
        if (addNewsChk.checked) {
          apAddSystemNews(mode, selected.length);
        }

        apRenderSnapshot();
        apSetStatus('Saved new Autopilot pack with ' + pack.tracks.length + ' track(s) and updated radio state.', false);
      }

      btnRefresh?.addEventListener('click', () => {
        apSetStatus('', false);
        apRenderSnapshot();
        buildPool();
      });

      btnPreview?.addEventListener('click', () => {
        previewPack();
      });

      btnGenerate?.addEventListener('click', () => {
        generatePack();
      });

      // Initial render
      apRenderSnapshot();
      buildPool();
    });
  </script>
  <script type="module" src="/js/tkfm-gate.js"></script>
</body>
</html>

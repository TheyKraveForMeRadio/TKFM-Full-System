<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Autopilot Engine — TKFM</title>
  <meta name="robots" content="noindex,nofollow"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/js/tkfm-owner-guard.js"></script>
  <style>
    body{
      background:#020617;
      background-image:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.22),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(236,72,153,0.30),transparent 55%),
        radial-gradient(circle at 50% 100%,rgba(168,85,247,0.28),transparent 55%);
    }
    .card{background:rgba(2,6,23,.62);border:1px solid rgba(148,163,184,.18)}
    .pill{font-size:.7rem;letter-spacing:.28em;text-transform:uppercase}
    .btn{border-radius:999px;font-size:.74rem;letter-spacing:.18em;text-transform:uppercase;font-weight:900;padding:.6rem 1rem;white-space:nowrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
  </style>
</head>
<body class="text-slate-50 min-h-screen">
  <header class="sticky top-0 z-40 border-b border-slate-800/80 bg-black/80 backdrop-blur-xl">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-4">
      <a href="radio-hub.html" class="flex items-center gap-3">
        <img src="/tkfm-radio-logo.png" class="h-9 w-auto object-contain" alt="TKFM"/>
        <div class="leading-tight">
          <p class="text-[0.6rem] uppercase tracking-[0.35em] text-slate-400">They Krave For Me Radio</p>
          <p class="text-sm font-semibold">Autopilot Engine</p>
        </div>
      </a>
      <nav class="ml-auto flex flex-wrap gap-2 text-[0.7rem] uppercase tracking-[0.22em]">
        <a href="god-view.html" class="px-3 py-1 rounded-full border border-purple-400/80 bg-purple-400/10 text-purple-200">God View</a>
        <a href="owner-login.html?next=autopilot-engine.html" class="px-3 py-1 rounded-full border border-pink-400/80 bg-pink-400/10 text-pink-200">Owner Login</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-10 pb-16 space-y-6">
    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-sky-400/80 bg-sky-400/10 pill text-sky-200">
      <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
      <span>Stability Wrapper</span>
    </div>

    <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">Autopilot Engine</h1>
    <p class="text-slate-200/85 max-w-4xl">
      This page stops the <b>blink loop</b> by loading your original Autopilot UI from a safe copy and stripping any
      owner-login redirect scripts before rendering.
    </p>

    <div id="locked" class="card rounded-2xl p-6 hidden">
      <h2 class="text-2xl font-extrabold">Access Locked</h2>
      <p class="text-slate-200/85 mt-2">
        Login as owner first. We won’t auto-redirect (no blinking).
      </p>
      <div class="mt-4 flex flex-wrap gap-2">
        <a class="btn border border-pink-500/40 bg-pink-500/10 text-pink-100 hover:bg-pink-500/15"
           href="owner-login.html?next=autopilot-engine.html">Owner Login</a>
        <button class="btn border border-slate-500/40 bg-slate-500/10 text-slate-100 hover:bg-slate-500/15" id="clear">
          Clear Owner Session
        </button>
      </div>
      <p class="text-xs text-slate-500 mt-3">
        Tip: If you’re on a new device, login once so owner keys are stored.
      </p>
    </div>

    <div id="loader" class="card rounded-2xl p-6 hidden">
      <h2 class="text-2xl font-extrabold">Loading original Autopilot UI…</h2>
      <p class="text-slate-200/85 mt-2">Source: <span class="mono">/originals/autopilot-engine.original.html</span></p>
      <p id="status" class="text-sm font-semibold text-slate-300 mt-3"></p>
    </div>

    <div id="frameWrap" class="card rounded-2xl p-2 hidden">
      <iframe id="frame" class="w-full rounded-xl" style="height:80vh" referrerpolicy="no-referrer"
              sandbox="allow-scripts allow-forms allow-popups allow-downloads allow-modals allow-pointer-lock allow-same-origin"></iframe>
    </div>

    <div id="missing" class="card rounded-2xl p-6 hidden">
      <h2 class="text-2xl font-extrabold">Original file missing</h2>
      <p class="text-slate-200/85 mt-2">
        You must move your current <span class="mono">autopilot-engine.html</span> into:
        <span class="mono">/originals/autopilot-engine.original.html</span>
        before this wrapper can load it.
      </p>
      <p class="text-slate-400 text-sm mt-3">
        (The unzip steps I gave you do this automatically.)
      </p>
    </div>
  </main>

  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      function isOwner(){
        return (window.TKFM_OWNER_GUARD && window.TKFM_OWNER_GUARD.isOwnerLocal && window.TKFM_OWNER_GUARD.isOwnerLocal());
      }

      function clearOwner(){
        if (window.TKFM_OWNER_GUARD && window.TKFM_OWNER_GUARD.clearOwner) window.TKFM_OWNER_GUARD.clearOwner();
        location.reload();
      }

      function stripGates(html){
        let out = String(html || '');

        // 1) Remove external gate scripts
        out = out.replace(/<script[^>]+src=["'][^"']*(auth-gateway|owner|gate)[^"']*["'][^>]*>\s*<\/script>/gi, '');

        // 2) Remove inline scripts that mention owner-login redirect
        out = out.replace(/<script[^>]*>[\s\S]*?(owner-login|owner_login|Owner\s*Login|TKFM_OWNER)[\s\S]*?<\/script>/gi, '');

        // 3) Neutralize direct window.location redirects to owner-login
        out = out.replace(/window\.location\s*=\s*['"][^'"]*owner-login[^'"]*['"]/gi, '/* stripped redirect */');
        out = out.replace(/location\.replace\(\s*['"][^'"]*owner-login[^'"]*['"]\s*\)/gi, '/* stripped replace */');
        out = out.replace(/location\.href\s*=\s*['"][^'"]*owner-login[^'"]*['"]/gi, '/* stripped href */');

        // Ensure base href so relative assets resolve from site root
        if (!/\<base\s/i.test(out)){
          out = out.replace(/<head([^>]*)>/i, '<head$1>\n  <base href="/"/>');
        }
        return out;
      }

      async function loadOriginal(){
        $('loader').classList.remove('hidden');
        $('status').textContent = 'Fetching original HTML…';

        const url = '/originals/autopilot-engine.original.html?ts=' + Date.now();
        const res = await fetch(url, { cache: 'no-store' });

        if (!res.ok){
          $('loader').classList.add('hidden');
          $('missing').classList.remove('hidden');
          return;
        }

        const html = await res.text();
        $('status').textContent = 'Sanitizing redirect scripts…';

        const cleaned = stripGates(html);

        // EXTRA: guarantee legacy keys for old inline checks
        try{
          const key = (localStorage.getItem('TKFM_OWNER_KEY') || localStorage.getItem('tkfm_owner_key') || '').trim();
          const email = (localStorage.getItem('ownerEmail') || localStorage.getItem('tkfm_owner_email') || '').trim();
          const token = (localStorage.getItem('tkfm_owner_token') || '').trim();
          if (window.TKFM_OWNER_GUARD && window.TKFM_OWNER_GUARD.setLegacyKeys && key){
            window.TKFM_OWNER_GUARD.setLegacyKeys({ email, ownerKey: key, token });
          }
        }catch(e){}

        $('status').textContent = 'Rendering…';
        $('frameWrap').classList.remove('hidden');
        $('loader').classList.add('hidden');

        const frame = $('frame');
        frame.srcdoc = cleaned;
      }

      $('clear').addEventListener('click', clearOwner);

      if (!isOwner()){
        $('locked').classList.remove('hidden');
        return;
      }

      loadOriginal();
    })();
  </script>

  <footer class="border-t border-slate-800/80 bg-black/80 backdrop-blur-xl">
    <div class="max-w-6xl mx-auto px-4 py-6 text-xs text-slate-400 flex flex-wrap items-center justify-between gap-3">
      <p>© <span id="year"></span> They Krave For Me Radio</p>
      <div class="flex gap-2 flex-wrap">
        <a class="hover:text-slate-200" href="radio-hub.html">Radio Hub</a><span>•</span>
        <a class="hover:text-slate-200" href="owner-login.html">Owner Login</a>
      </div>
    </div>
  </footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>
</body>
</html>

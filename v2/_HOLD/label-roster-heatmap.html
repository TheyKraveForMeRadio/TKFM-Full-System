<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>They Krave For Me Records • Roster Heatmap HQ</title>

  <style>
    :root {
      --bg-deep: #020617;
      --bg-card: rgba(10,10,10,0.98);
      --accent-gold: #facc15;
      --accent-amber: #f59e0b;
      --accent-orange: #fb923c;
      --accent-teal: #22d3ee;
      --accent-rose: #fb7185;
      --accent-lime: #a3e635;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-soft: rgba(148,163,184,0.7);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 0 0, rgba(250,204,21,0.2), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(251,146,60,0.18), transparent 55%),
        radial-gradient(circle at 50% 115%, #020617, #000000 70%);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bg-orbit {
      position: fixed;
      width: 520px;
      height: 520px;
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,0.8);
      inset: -140px auto auto -200px;
      opacity: .9;
      mix-blend-mode: screen;
      box-shadow:
        0 0 150px rgba(250,204,21,1),
        0 0 220px rgba(0,0,0,1);
      animation: spin 34s linear infinite;
      pointer-events: none;
    }
    .bg-orbit::before {
      content: "";
      position: absolute;
      inset: 18%;
      border-radius: inherit;
      border: 1px solid rgba(251,146,60,0.9);
      box-shadow:
        0 0 100px rgba(251,146,60,1),
        0 0 180px rgba(0,0,0,1);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .scanline {
      position: fixed;
      inset: 0;
      background-image: linear-gradient(
        to bottom,
        rgba(15,23,42,0) 0px,
        rgba(15,23,42,0.6) 1px,
        rgba(15,23,42,0) 2px
      );
      background-size: 100% 3px;
      mix-blend-mode: soft-light;
      opacity: .45;
      pointer-events: none;
    }

    main {
      max-width: 1180px;
      margin: 0 auto;
      padding: 1.7rem .9rem 2.6rem;
      position: relative;
      z-index: 1;
    }

    /* NAV */
    .nav-bar {
      display: flex;
      align-items: center;
      gap: .9rem;
      margin-bottom: 1.4rem;
    }
    .nav-logo {
      display: flex;
      align-items: center;
      gap: .55rem;
    }
    .nav-pill {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .78rem;
      font-weight: 800;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: #fefce8;
      background:
        radial-gradient(circle at 0 0, rgba(250,204,21,0.38), transparent 60%),
        radial-gradient(circle at 100% 100%, #020617, #000000 65%);
      box-shadow:
        0 0 28px rgba(250,204,21,1),
        0 0 44px rgba(0,0,0,1);
    }
    .nav-text {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .nav-main {
      font-size: .95rem;
      font-weight: 900;
      letter-spacing: .24em;
      text-transform: uppercase;
      color: #fef9c3;
    }
    .nav-sub {
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--text-muted);
    }
    .nav-spacer {
      margin-left: auto;
      display: flex;
      gap: .4rem;
      flex-wrap: wrap;
    }
    .nav-chip {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.9);
      background: rgba(10,10,10,0.98);
      padding: .22rem .7rem;
      font-size: .72rem;
      letter-spacing: .14em;
      text-transform: uppercase;
    }
    .nav-chip--gold {
      border-color: rgba(250,204,21,0.9);
      color: #fef9c3;
      box-shadow:
        0 0 20px rgba(250,204,21,0.9),
        0 0 32px rgba(0,0,0,1);
    }

    /* SHELL */
    .shell {
      border-radius: 30px;
      border: 1px solid rgba(250,204,21,0.9);
      background:
        radial-gradient(circle at 0 0, rgba(250,204,21,0.22), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(251,146,60,0.18), transparent 60%),
        radial-gradient(circle at 50% 130%, #020617, #000000 75%);
      padding: 1.6rem 1.5rem 1.9rem;
      box-shadow:
        0 0 110px rgba(15,23,42,1),
        0 0 180px rgba(0,0,0,1);
      position: relative;
      overflow: hidden;
      margin-bottom: 1.7rem;
    }
    .shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 100%, rgba(251,113,133,0.25), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(56,189,248,0.16), transparent 60%);
      mix-blend-mode: screen;
      opacity: .9;
      pointer-events: none;
    }
    .shell-inner { position: relative; z-index: 1; }

    .kicker {
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .18em;
      color: #fde68a;
      margin-bottom: .4rem;
    }
    h1 {
      margin: 0;
      font-size: 1.9rem;
      font-weight: 900;
      letter-spacing: .26em;
      text-transform: uppercase;
      background: linear-gradient(120deg,#fef3c7,#facc15,#fb923c,#f97316);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      text-shadow:
        0 0 46px rgba(250,204,21,0.9),
        0 0 80px rgba(0,0,0,1);
    }
    .hero-sub {
      margin-top: .7rem;
      font-size: .9rem;
      color: #e5e7eb;
      max-width: 680px;
    }
    .hero-sub strong { color: #fef9c3; }

    /* CONTROLS + GRID */
    .top-row {
      display: grid;
      grid-template-columns: minmax(0,1.1fr) minmax(0,0.9fr);
      gap: 1.1rem;
      margin-top: 1.1rem;
    }
    @media (max-width: 980px) {
      .top-row { grid-template-columns: minmax(0,1fr); }
    }

    .control-card {
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,0.9);
      background:
        radial-gradient(circle at 0 0, rgba(250,204,21,0.12), transparent 60%),
        rgba(10,10,10,0.98);
      padding: .9rem 1.05rem 1.1rem;
      box-shadow: 0 0 32px rgba(0,0,0,1);
      font-size: .8rem;
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: .7rem;
      margin-top: .7rem;
    }
    @media (max-width: 720px) {
      .control-grid { grid-template-columns: minmax(0,1fr); }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: .18rem;
    }
    label {
      font-size: .74rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--text-muted);
    }
    input[type="text"],
    select {
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,1);
      background: rgba(10,10,10,0.98);
      color: var(--text-main);
      padding: .5rem .8rem;
      font-size: .8rem;
      outline: none;
      width: 100%;
    }
    input:focus,
    select:focus {
      border-color: rgba(250,204,21,1);
      box-shadow:
        0 0 20px rgba(250,204,21,0.9),
        0 0 30px rgba(0,0,0,1);
    }

    .hint {
      font-size: .7rem;
      color: var(--text-muted);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
      margin-top: .6rem;
      font-size: .75rem;
    }
    .chip {
      border-radius: 999px;
      padding: .22rem .7rem;
      border: 1px solid rgba(75,85,99,1);
      background: rgba(15,23,42,0.96);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: .3rem;
    }
    .chip[data-active="true"] {
      border-color: rgba(250,204,21,1);
      background: radial-gradient(circle at 0 0, rgba(250,204,21,0.4), rgba(15,23,42,1));
      box-shadow:
        0 0 22px rgba(250,204,21,0.9),
        0 0 28px rgba(0,0,0,1);
      color: #fef9c3;
    }
    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-gold);
      box-shadow: 0 0 14px rgba(250,204,21,1);
    }
    .chip-dot.artist { background: var(--accent-rose); box-shadow: 0 0 14px rgba(251,113,133,1); }
    .chip-dot.dj     { background: var(--accent-teal); box-shadow: 0 0 14px rgba(45,212,191,1); }
    .chip-dot.sponsor{ background: var(--accent-lime); box-shadow: 0 0 14px rgba(163,230,53,1); }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin-top: .7rem;
    }
    .btn-main {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: .45rem 1.3rem;
      font-size: .8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .18em;
      color: #020617;
      background: linear-gradient(120deg,#facc15,#f97316,#fbbf24);
      box-shadow:
        0 0 24px rgba(250,204,21,1),
        0 0 32px rgba(0,0,0,1);
    }
    .btn-ghost {
      border-radius: 999px;
      padding: .42rem 1.1rem;
      border: 1px solid rgba(148,163,184,0.9);
      background: rgba(10,10,10,0.98);
      color: var(--text-main);
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      cursor: pointer;
    }

    /* MINIMAP */
    .minimap-card {
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,0.9);
      background: rgba(10,10,10,0.98);
      padding: .85rem .95rem 1rem;
      box-shadow: 0 0 30px rgba(0,0,0,1);
      font-size: .78rem;
      position: relative;
      overflow: hidden;
    }
    .minimap-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 100% 0, rgba(250,204,21,0.18), transparent 60%);
      mix-blend-mode: screen;
      opacity: .9;
      pointer-events: none;
    }
    .minimap-inner { position: relative; z-index: 1; }

    .card-kicker {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--text-muted);
      margin-bottom: .18rem;
    }
    .card-title {
      font-size: .9rem;
      font-weight: 600;
      margin: 0 0 .4rem;
    }
    .legend-row {
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
      margin-bottom: .4rem;
    }
    .legend-pill {
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,1);
      padding: .16rem .5rem;
      display: inline-flex;
      align-items: center;
      gap: .3rem;
    }
    .legend-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-gold);
    }

    .bar-row {
      display: flex;
      flex-direction: column;
      gap: .25rem;
      margin-top: .3rem;
      font-size: .75rem;
    }
    .bar-label {
      display: flex;
      justify-content: space-between;
      color: var(--text-muted);
    }
    .bar-track {
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,1);
      background: #020617;
      overflow: hidden;
      height: 7px;
    }
    .bar-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg,#22c55e,#facc15,#fb923c);
      width: 40%;
      box-shadow: 0 0 20px rgba(250,204,21,0.9);
    }

    /* GRID */
    .grid-shell {
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.9);
      background: rgba(10,10,10,0.98);
      padding: 1rem 1.05rem 1.2rem;
      box-shadow: 0 0 40px rgba(0,0,0,1);
      font-size: .8rem;
    }
    .grid-header {
      display: flex;
      justify-content: space-between;
      gap: .7rem;
      align-items: baseline;
      margin-bottom: .6rem;
    }
    .grid-title {
      font-size: .86rem;
      text-transform: uppercase;
      letter-spacing: .18em;
    }
    .grid-sub {
      font-size: .75rem;
      color: var(--text-muted);
    }

    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(4,minmax(0,1fr));
      gap: .75rem;
      margin-top: .4rem;
    }
    @media (max-width: 1080px) {
      .heatmap-grid { grid-template-columns: repeat(3,minmax(0,1fr)); }
    }
    @media (max-width: 820px) {
      .heatmap-grid { grid-template-columns: repeat(2,minmax(0,1fr)); }
    }
    @media (max-width: 640px) {
      .heatmap-grid { grid-template-columns: minmax(0,1fr); }
    }

    .card {
      border-radius: 18px;
      border: 1px solid rgba(55,65,81,1);
      background: radial-gradient(circle at 0 0, rgba(250,204,21,0.12), rgba(15,15,15,0.98));
      padding: .65rem .7rem .8rem;
      position: relative;
      overflow: hidden;
      cursor: default;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(250,204,21,0.18), transparent 60%),
        radial-gradient(circle at 100% 100%, rgba(15,23,42,0.9), transparent 60%);
      mix-blend-mode: screen;
      opacity: .75;
      pointer-events: none;
    }
    .card-inner { position: relative; z-index: 1; }

    .card:hover {
      transform: translateY(-3px);
      box-shadow:
        0 0 26px rgba(250,204,21,0.9),
        0 0 38px rgba(0,0,0,1);
      border-color: rgba(250,204,21,0.95);
    }

    .tag-row {
      display: flex;
      justify-content: space-between;
      gap: .4rem;
      align-items: center;
      margin-bottom: .4rem;
    }
    .tag-main {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .18em;
      color: #fef9c3;
    }
    .tag-pill {
      font-size: .7rem;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,1);
      padding: .12rem .5rem;
      text-transform: uppercase;
      letter-spacing: .1em;
    }

    .name {
      font-size: .9rem;
      font-weight: 600;
      margin-bottom: .15rem;
    }
    .role {
      font-size: .76rem;
      color: var(--text-muted);
      margin-bottom: .3rem;
    }

    .metric-row {
      display: flex;
      flex-direction: column;
      gap: .18rem;
      font-size: .74rem;
    }
    .metric {
      display: flex;
      justify-content: space-between;
    }

    .heat-bar {
      margin-top: .3rem;
    }
    .heat-track {
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,1);
      height: 6px;
      overflow: hidden;
    }
    .heat-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg,#22c55e,#facc15,#fb923c,#ef4444);
      width: 50%;
      box-shadow: 0 0 18px rgba(250,204,21,0.9);
    }
    .heat-label {
      display: flex;
      justify-content: space-between;
      font-size: .72rem;
      color: var(--text-muted);
      margin-top: .16rem;
    }

    .footer-note {
      margin-top: .8rem;
      font-size: .74rem;
      text-align: center;
      color: var(--text-muted);
    }

    @media (prefers-reduced-motion: reduce) {
      .bg-orbit { animation: none; }
    }
  </style>
</head>
<body>
<div class="bg-orbit"></div>
<div class="scanline"></div>

<main>
  <header class="nav-bar">
    <div class="nav-logo">
      <div class="nav-pill">KR</div>
      <div class="nav-text">
        <div class="nav-main">They Krave For Me Records</div>
        <div class="nav-sub">Roster Heatmap HQ</div>
      </div>
    </div>
    <div class="nav-spacer">
      <div class="nav-chip nav-chip--gold">Owner / Label view</div>
      <div class="nav-chip">Cross label + TKFM motion</div>
    </div>
  </header>

  <section class="shell">
    <div class="shell-inner">
      <div class="kicker">Who’s hotter: artists, DJs, or sponsors?</div>
      <h1>See your whole roster as a heatmap.</h1>
      <p class="hero-sub">
        One screen to glance who’s <strong>moving</strong>: spins, features, pack revenue,
        and sponsor energy. Later this can plug directly into your TKFM data, label packs,
        and feature revenue engine.
      </p>

      <div class="top-row">
        <!-- LEFT: CONTROLS -->
        <div class="control-card">
          <div class="card-kicker">Filters & modes</div>
          <div class="hint">
            Switch between <strong>Artists</strong>, <strong>DJs</strong>, and <strong>Sponsors</strong> and
            change the vibe of the heat scoring.
          </div>

          <div class="control-grid">
            <div class="field">
              <label for="viewType">View</label>
              <select id="viewType">
                <option value="all">All roster</option>
                <option value="artists">Artists only</option>
                <option value="djs">DJs only</option>
                <option value="sponsors">Sponsors only</option>
              </select>
              <p class="hint">Filters the cards below.</p>
            </div>
            <div class="field">
              <label for="heatMode">Heat mode</label>
              <select id="heatMode">
                <option value="motion">Motion (overall)</option>
                <option value="radio">Radio / TKFM</option>
                <option value="revenue">Revenue / packs</option>
                <option value="sponsors">Sponsor energy</option>
              </select>
              <p class="hint">Changes the emphasis of the heat meter.</p>
            </div>
            <div class="field">
              <label for="searchName">Search name</label>
              <input id="searchName" type="text" placeholder="Search roster…" />
              <p class="hint">Quick filter by artist / DJ / sponsor name.</p>
            </div>
          </div>

          <div class="chip-row">
            <button class="chip" type="button" data-chip="tag" data-value="priority" data-active="true">
              <span class="chip-dot"></span> Priority
            </button>
            <button class="chip" type="button" data-chip="tag" data-value="emerging" data-active="false">
              <span class="chip-dot artist"></span> Emerging
            </button>
            <button class="chip" type="button" data-chip="tag" data-value="dormant" data-active="false">
              <span class="chip-dot dj"></span> Dormant
            </button>
            <button class="chip" type="button" data-chip="tag" data-value="sponsor" data-active="false">
              <span class="chip-dot sponsor"></span> Sponsor-heavy
            </button>
          </div>

          <div class="btn-row">
            <button class="btn-main" type="button" id="refreshBtn">Refresh heatmap</button>
            <button class="btn-ghost" type="button" id="copySnapshotBtn">Copy snapshot</button>
          </div>
        </div>

        <!-- RIGHT: MINIMAP / SUMMARY -->
        <aside class="minimap-card">
          <div class="minimap-inner">
            <div class="card-kicker">Pulse overview</div>
            <h2 class="card-title">Current roster balance</h2>

            <div class="legend-row">
              <div class="legend-pill">
                <span class="legend-dot artist"></span>
                <span>Artists</span>
              </div>
              <div class="legend-pill">
                <span class="legend-dot dj" style="background: var(--accent-teal);"></span>
                <span>DJs</span>
              </div>
              <div class="legend-pill">
                <span class="legend-dot sponsor" style="background: var(--accent-lime);"></span>
                <span>Sponsors</span>
              </div>
            </div>

            <div class="bar-row">
              <div class="bar-label">
                <span>Artists in motion</span>
                <span id="miniArtistsCount">0</span>
              </div>
              <div class="bar-track">
                <div class="bar-fill" id="miniArtistsBar"></div>
              </div>

              <div class="bar-label">
                <span>DJs active</span>
                <span id="miniDjsCount">0</span>
              </div>
              <div class="bar-track">
                <div class="bar-fill" id="miniDjsBar"></div>
              </div>

              <div class="bar-label">
                <span>Sponsors engaged</span>
                <span id="miniSponsorsCount">0</span>
              </div>
              <div class="bar-track">
                <div class="bar-fill" id="miniSponsorsBar"></div>
              </div>
            </div>

            <p class="hint" style="margin-top:.6rem;">
              Later this can pull from <strong>label-accounts</strong>, <strong>artist-accounts</strong>,
              <strong>dj-accounts</strong>, and sponsor engines so you get live motion on one screen.
            </p>
          </div>
        </aside>
      </div>

      <!-- GRID -->
      <div class="grid-shell" style="margin-top:1.1rem;">
        <div class="grid-header">
          <div>
            <div class="grid-title">Roster heatmap</div>
            <div class="grid-sub">
              Cards are sorted by heat score. Higher means more combined motion from TKFM + label + sponsors.
            </div>
          </div>
          <div class="grid-sub" id="gridSummary">0 profiles, heat mode: Motion</div>
        </div>

        <div class="heatmap-grid" id="heatmapGrid">
          <!-- Cards injected by JS -->
        </div>
      </div>
    </div>
  </section>

  <p class="footer-note">
    They Krave For Me Records • Roster Heatmap HQ • One screen to see who’s really moving.
  </p>
</main>

<script type="module">
  import { supabase } from "./src/supabaseClient.js";
  import { protectPage } from "./auth-gateway.js";

  // Lock this to owner + label views
  protectPage(["owner", "label"]);

  const viewTypeEl = document.getElementById("viewType");
  const heatModeEl = document.getElementById("heatMode");
  const searchNameEl = document.getElementById("searchName");
  const chips = Array.from(document.querySelectorAll("[data-chip='tag']"));

  const refreshBtn = document.getElementById("refreshBtn");
  const copySnapshotBtn = document.getElementById("copySnapshotBtn");
  const heatmapGrid = document.getElementById("heatmapGrid");
  const gridSummaryEl = document.getElementById("gridSummary");

  const miniArtistsCountEl = document.getElementById("miniArtistsCount");
  const miniDjsCountEl = document.getElementById("miniDjsCount");
  const miniSponsorsCountEl = document.getElementById("miniSponsorsCount");
  const miniArtistsBarEl = document.getElementById("miniArtistsBar");
  const miniDjsBarEl = document.getElementById("miniDjsBar");
  const miniSponsorsBarEl = document.getElementById("miniSponsorsBar");

  // Fake data for now. Later this can pull from Supabase / Netlify functions.
  const roster = [
    {
      name: "Neon Cartier",
      role: "Artist",
      type: "artist",
      tag: "priority",
      lastPack: "KRAVE LAUNCH PACK",
      plays: 8500,
      features: 3,
      revenueIndex: 92,
      sponsorIndex: 60,
      radioIndex: 88
    },
    {
      name: "DJ Chrome Palace",
      role: "DJ / Mixtape",
      type: "dj",
      tag: "priority",
      lastPack: "TKFM GOD MODE MIXTAPE",
      plays: 6400,
      features: 4,
      revenueIndex: 80,
      sponsorIndex: 45,
      radioIndex: 90
    },
    {
      name: "Basement Syndicate",
      role: "Artist collective",
      type: "artist",
      tag: "emerging",
      lastPack: "BLOCK WAVE PACK",
      plays: 3200,
      features: 2,
      revenueIndex: 55,
      sponsorIndex: 20,
      radioIndex: 60
    },
    {
      name: "Night Shift FM",
      role: "Sponsor / Brand",
      type: "sponsor",
      tag: "sponsor",
      lastPack: "SPONSOR MEDIA PACK",
      plays: 0,
      features: 0,
      revenueIndex: 70,
      sponsorIndex: 95,
      radioIndex: 0
    },
    {
      name: "808 Shrine",
      role: "Producer / Artist",
      type: "artist",
      tag: "priority",
      lastPack: "PRODUCER PACK",
      plays: 5400,
      features: 3,
      revenueIndex: 76,
      sponsorIndex: 30,
      radioIndex: 72
    },
    {
      name: "DJ Alley Code",
      role: "DJ",
      type: "dj",
      tag: "emerging",
      lastPack: "TKFM ROTATION PACK",
      plays: 2100,
      features: 1,
      revenueIndex: 40,
      sponsorIndex: 15,
      radioIndex: 55
    },
    {
      name: "Third Rail Vodka",
      role: "Sponsor",
      type: "sponsor",
      tag: "sponsor",
      lastPack: "WHITE LABEL SPONSOR PACK",
      plays: 0,
      features: 0,
      revenueIndex: 88,
      sponsorIndex: 90,
      radioIndex: 0
    },
    {
      name: "Glowline",
      role: "Artist",
      type: "artist",
      tag: "dormant",
      lastPack: "BACK CATALOG PACK",
      plays: 900,
      features: 0,
      revenueIndex: 25,
      sponsorIndex: 0,
      radioIndex: 30
    }
  ];

  function activeTags() {
    return chips
      .filter(chip => chip.dataset.active === "true")
      .map(chip => chip.dataset.value);
  }

  function computeHeat(item, mode) {
    const base =
      (item.radioIndex + item.revenueIndex + item.sponsorIndex) / 3 || 0;

    if (mode === "radio") {
      return item.radioIndex;
    }
    if (mode === "revenue") {
      return item.revenueIndex;
    }
    if (mode === "sponsors") {
      return item.sponsorIndex;
    }

    // "motion" mode: slight boost for priority + plays
    let motion = base;
    if (item.tag === "priority") motion += 8;
    motion += Math.min(item.plays / 1000, 15);
    return Math.max(0, Math.min(100, motion));
  }

  function filterAndScore() {
    const view = viewTypeEl.value;
    const mode = heatModeEl.value;
    const search = searchNameEl.value.trim().toLowerCase();
    const tags = activeTags();

    const filtered = roster
      .filter(item => {
        if (view === "artists" && item.type !== "artist") return false;
        if (view === "djs" && item.type !== "dj") return false;
        if (view === "sponsors" && item.type !== "sponsor") return false;

        if (tags.length && !tags.includes(item.tag)) return false;
        if (search && !item.name.toLowerCase().includes(search)) return false;

        return true;
      })
      .map(item => ({
        ...item,
        heat: computeHeat(item, mode)
      }))
      .sort((a, b) => b.heat - a.heat);

    return filtered;
  }

  function renderGrid() {
    const mode = heatModeEl.value;
    const filtered = filterAndScore();

    heatmapGrid.innerHTML = "";

    filtered.forEach(item => {
      const card = document.createElement("article");
      card.className = "card";

      const tagLabel =
        item.type === "artist"
          ? "Artist"
          : item.type === "dj"
          ? "DJ"
          : "Sponsor";

      const tagClass =
        item.tag === "priority"
          ? "PRIORITY"
          : item.tag === "emerging"
          ? "EMERGING"
          : item.tag === "dormant"
          ? "DORMANT"
          : "SPONSOR";

      const radioLine =
        item.radioIndex > 0
          ? `${item.radioIndex}/100`
          : "—";

      const revLine =
        item.revenueIndex > 0
          ? `${item.revenueIndex}/100`
          : "—";

      const sponsorLine =
        item.sponsorIndex > 0
          ? `${item.sponsorIndex}/100`
          : "—";

      const playsLine = item.plays > 0 ? item.plays.toLocaleString() : "—";

      card.innerHTML = `
        <div class="card-inner">
          <div class="tag-row">
            <span class="tag-main">${tagLabel}</span>
            <span class="tag-pill">${tagClass}</span>
          </div>
          <div class="name">${item.name}</div>
          <div class="role">${item.role} • Last pack: ${item.lastPack}</div>
          <div class="metric-row">
            <div class="metric">
              <span>TKFM plays</span>
              <span>${playsLine}</span>
            </div>
            <div class="metric">
              <span>Radio heat</span>
              <span>${radioLine}</span>
            </div>
            <div class="metric">
              <span>Pack / revenue index</span>
              <span>${revLine}</span>
            </div>
            <div class="metric">
              <span>Sponsor energy</span>
              <span>${sponsorLine}</span>
            </div>
          </div>
          <div class="heat-bar">
            <div class="heat-track">
              <div
                class="heat-fill"
                style="width:${item.heat}%;"
              ></div>
            </div>
            <div class="heat-label">
              <span>Heat score</span>
              <span>${Math.round(item.heat)}/100</span>
            </div>
          </div>
        </div>
      `;

      heatmapGrid.appendChild(card);
    });

    updateSummary(filtered);
  }

  function updateSummary(list) {
    const modeLabel =
      heatModeEl.options[heatModeEl.selectedIndex]?.textContent || "Motion";

    gridSummaryEl.textContent = `${list.length} profiles, heat mode: ${modeLabel}`;

    // Update mini bars using ALL roster, not just filtered
    const artists = roster.filter(r => r.type === "artist").length;
    const djs = roster.filter(r => r.type === "dj").length;
    const sponsors = roster.filter(r => r.type === "sponsor").length;
    const max = Math.max(artists, djs, sponsors, 1);

    miniArtistsCountEl.textContent = artists;
    miniDjsCountEl.textContent = djs;
    miniSponsorsCountEl.textContent = sponsors;

    miniArtistsBarEl.style.width = `${(artists / max) * 100}%`;
    miniDjsBarEl.style.width = `${(djs / max) * 100}%`;
    miniSponsorsBarEl.style.width = `${(sponsors / max) * 100}%`;
  }

  function viewLabel(value) {
    switch (value) {
      case "artists": return "Artists only";
      case "djs": return "DJs only";
      case "sponsors": return "Sponsors only";
      default: return "All roster";
    }
  }

  function buildSnapshotText() {
    const filtered = filterAndScore();
    const modeLabel =
      heatModeEl.options[heatModeEl.selectedIndex]?.textContent || "Motion";
    const view = viewLabel(viewTypeEl.value);

    const lines = [];

    lines.push("They Krave For Me Records — Roster Heatmap HQ");
    lines.push(`View: ${view}`);
    lines.push(`Heat mode: ${modeLabel}`);
    lines.push("");

    filtered.forEach(item => {
      lines.push(
        `${item.name} (${item.type.toUpperCase()}, ${item.tag}) — Heat ${Math.round(
          item.heat
        )}/100`
      );
      lines.push(
        `  Plays: ${item.plays.toLocaleString()} | Radio: ${item.radioIndex}/100 | Revenue: ${item.revenueIndex}/100 | Sponsor: ${item.sponsorIndex}/100`
      );
      lines.push(`  Last pack: ${item.lastPack}`);
      lines.push("");
    });

    if (!filtered.length) {
      lines.push("No profiles visible with the current filters.");
    }

    lines.push(
      "Internal use only — tie this view back to label accounts, AI pack builder, and contract lab for decisions."
    );

    return lines.join("\n");
  }

  // Event wiring
  chips.forEach(chip => {
    chip.addEventListener("click", () => {
      const active = chip.dataset.active === "true";
      chip.dataset.active = active ? "false" : "true";
      renderGrid();
    });
  });

  viewTypeEl.addEventListener("change", renderGrid);
  heatModeEl.addEventListener("change", renderGrid);
  searchNameEl.addEventListener("input", () => {
    // Tiny debounce feel
    window.clearTimeout(searchNameEl._t);
    searchNameEl._t = setTimeout(renderGrid, 150);
  });

  refreshBtn.addEventListener("click", () => {
    renderGrid();
  });

  copySnapshotBtn.addEventListener("click", async () => {
    const text = buildSnapshotText();
    try {
      await navigator.clipboard.writeText(text);
      copySnapshotBtn.textContent = "Copied!";
      setTimeout(() => {
        copySnapshotBtn.textContent = "Copy snapshot";
      }, 1400);
    } catch (err) {
      console.error("Clipboard error", err);
      copySnapshotBtn.textContent = "Copy failed";
      setTimeout(() => {
        copySnapshotBtn.textContent = "Copy snapshot";
      }, 1600);
    }
  });

  // Initial render
  renderGrid();
</script>
</body>
</html>

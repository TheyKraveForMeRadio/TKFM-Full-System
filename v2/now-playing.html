<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TKFM — Now Playing</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/js/logo-check.js" defer></script>
  <style>
    body{
      background:#020617;
      background-image:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.25),transparent 60%),
        radial-gradient(circle at 100% 0,rgba(236,72,153,0.25),transparent 60%);
    }
  </style>
</head>
<body class="text-slate-50 min-h-screen flex items-center justify-center">

  <main class="w-full max-w-md px-4">
    <section class="rounded-2xl border border-slate-800 bg-slate-950/90 p-4 text-sm space-y-3 shadow-[0_0_35px_rgba(15,23,42,0.9)]">
      <header class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse shadow-[0_0_0_4px_rgba(52,211,153,0.45)]"></span>
          <div>
            <p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-400">
              They Krave For Me Radio
            </p>
            <p class="text-xs text-slate-300">
              Now Playing (Local Dev)
            </p>
          </div>
        </div>
        <a href="radio-hub.html" class="text-[0.7rem] text-cyan-300 hover:text-cyan-100">
          Hub ↗
        </a>
      </header>

      <div id="np-empty" class="text-[0.85rem] text-slate-300">
        No active rotation yet. Open <span class="text-cyan-300">Radio Hub</span> and load an Autopilot pack.
      </div>

      <div id="np-main" class="hidden space-y-2">
        <div>
          <p id="np-title" class="text-lg font-semibold truncate">
            —
          </p>
          <p id="np-artist" class="text-sm text-slate-200 truncate">
            —
          </p>
          <p id="np-meta" class="text-xs text-slate-400 truncate">
            —
          </p>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-2 text-[0.75rem] text-slate-300">
          <div class="flex flex-wrap gap-2">
            <span id="np-mode" class="px-2.5 py-1 rounded-full border border-purple-500/80 bg-purple-500/10 text-purple-100">
              Mode: —
            </span>
            <span id="np-index" class="px-2.5 py-1 rounded-full border border-slate-700/80 bg-slate-900/90">
              —
            </span>
          </div>
          <span id="np-updated" class="text-[0.7rem] text-slate-400">
            —
          </span>
        </div>
      </div>
    </section>
  </main>

  <script>
    function npSafeParse(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch (e) {
        console.warn('Now Playing: failed to parse', key, e);
        return fallback;
      }
    }

    function npPrettyDate(iso) {
      if (!iso) return '';
      try {
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return '';
        return d.toLocaleTimeString();
      } catch {
        return '';
      }
    }

    function npEscape(str) {
      return String(str || '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    function npRender() {
      const emptyEl = document.getElementById('np-empty');
      const mainEl = document.getElementById('np-main');
      const titleEl = document.getElementById('np-title');
      const artistEl = document.getElementById('np-artist');
      const metaEl = document.getElementById('np-meta');
      const modeEl = document.getElementById('np-mode');
      const indexEl = document.getElementById('np-index');
      const updatedEl = document.getElementById('np-updated');

      const pack = npSafeParse('tkfm_autopilot_last_pack', null);
      const now = npSafeParse('tkfm_radio_now_playing', null);

      const tracks = pack && Array.isArray(pack.tracks)
        ? pack.tracks
        : pack && Array.isArray(pack.items)
          ? pack.items
          : [];

      if (!pack || !now || !tracks.length) {
        mainEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
        return;
      }

      const idx = Number.isInteger(now.index) ? now.index : 0;
      const track = tracks[idx] || now.track || null;

      if (!track) {
        mainEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
        return;
      }

      const title = track.trackTitle || track.title || 'Untitled Record';
      const artist = track.artistName || track.artist || 'Unknown Artist';
      const city = track.city || '';
      const tag = track.tag || track.tier || '';
      const source = track.source || track.sourceKey || '';

      titleEl.textContent = title;
      artistEl.textContent = artist;
      metaEl.textContent = [
        city ? 'City: ' + city : '',
        tag ? 'Tag: ' + tag : '',
        source ? 'Source: ' + source : ''
      ].filter(Boolean).join(' • ') || 'Rotation record';

      const mode = pack.mode || pack.profile || now.mode || 'default';
      modeEl.textContent = 'Mode: ' + mode;
      indexEl.textContent = (idx + 1) + ' / ' + tracks.length;

      const updated = now.updatedAt || pack.createdAt || pack.timestamp || '';
      updatedEl.textContent = updated ? ('Updated ' + npPrettyDate(updated)) : '';

      emptyEl.classList.add('hidden');
      mainEl.classList.remove('hidden');
    }

    document.addEventListener('DOMContentLoaded', function () {
      npRender();
      // Optional small auto-refresh so the widget stays synced if Radio Hub moves tracks
      setInterval(npRender, 4000);
    });
  </script>
</body>
</html>

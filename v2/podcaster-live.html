<!doctype html>
<html lang="en">
<head>
  <title>Podcaster Live Dashboard ‚Äî TKFM</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/tkfm-ui.js" defer></script>
  <script src="/js/tkfm-unlocks.js" defer></script>
  <script src="/js/tkfm-checkout.js" defer></script>
  <script src="/js/tkfm-subscription-guard.js" defer></script>
  <style>
    body{
      background:#020617;
      background-image:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.22),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(236,72,153,0.30),transparent 55%),
        radial-gradient(circle at 50% 100%,rgba(168,85,247,0.28),transparent 55%),
        radial-gradient(circle at 60% 50%,rgba(250,204,21,0.08),transparent 60%);
    }
    .card{background:rgba(2,6,23,.55);border:1px solid rgba(148,163,184,.18)}
    .pill{font-size:.7rem;letter-spacing:.28em;text-transform:uppercase}
    .btn{border-radius:999px;font-size:.78rem;letter-spacing:.18em;text-transform:uppercase;font-weight:800;padding:.65rem 1rem;white-space:nowrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    input,textarea,select{background:rgba(2,6,23,.55)!important;border:1px solid rgba(148,163,184,.22)!important}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;z-index:9999;max-width:92vw}
  </style>
</head>
<body class="text-slate-50 min-h-screen">
  <header class="sticky top-0 z-40 border-b border-slate-800/80 bg-black/80 backdrop-blur-xl">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <a href="index.html" class="flex items-center gap-3">
        <img src="/tkfm-radio-logo.png" class="h-9 w-auto object-contain" alt="TKFM"/>
        <div class="leading-tight">
          <p class="text-[0.6rem] uppercase tracking-[0.35em] text-slate-400">They Krave For Me Radio</p>
          <p class="text-sm font-semibold">Podcaster Live Dashboard</p>
        </div>
      </a>
      <nav class="ml-auto flex flex-wrap gap-2 text-[0.7rem] uppercase tracking-[0.22em]">
        <a href="podcast-engine.html" class="px-3 py-1 rounded-full border border-emerald-400/80 bg-emerald-400/10 text-emerald-200">üéô Podcast</a>
        <a href="radio-tv.html" class="px-3 py-1 rounded-full border border-purple-400/80 bg-purple-400/10 text-purple-200">üì∫ TV</a>
        <a href="live.html" class="px-3 py-1 rounded-full border border-red-400/80 bg-red-400/10 text-red-200">üî¥ Live</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 pt-8 pb-14 space-y-8">
    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-sky-400/80 bg-sky-400/10 pill text-sky-200">
      <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
      <span>Paid Podcaster Lane</span>
    </div>

    <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
      Request a Live Cast ‚Äî server verified monthly access.
    </h1>

    <p class="text-slate-200/85 max-w-4xl">
      This page checks Stripe subscriptions (active/trialing) using your checkout email before allowing Live requests.
      No fake localStorage unlocks.
    </p>

    <div id="locked" class="card rounded-2xl p-6 hidden">
      <h2 class="text-2xl font-extrabold">Locked</h2>
      <p id="lockMsg" class="text-slate-200/85 mt-2">Checking subscription‚Ä¶</p>
      <div class="mt-4 flex flex-wrap gap-2">
        <a class="btn border border-emerald-500/40 bg-emerald-500/10 text-emerald-100 hover:bg-emerald-500/15" href="podcast-engine.html">Get Monthly</a>
        <a class="btn border border-purple-500/40 bg-purple-500/10 text-purple-100 hover:bg-purple-500/15" href="radio-tv.html">View TV</a>
      </div>
      <p class="text-slate-400 text-xs mt-4">Required plan: <span class="mono">video_creator_pass_monthly</span></p>
      <p class="text-slate-500 text-xs mt-1">Email key: <span class="mono">tkfm_customer_email</span></p>
    </div>

    <div id="unlocked" class="grid gap-4 hidden">
      <div class="card rounded-2xl p-6">
        <p class="text-slate-400 text-xs uppercase tracking-[0.28em]">Live Request</p>
        <h2 class="text-2xl font-extrabold mt-2">Submit what you‚Äôre going live with</h2>

        <div class="mt-4 grid md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label class="text-xs uppercase tracking-[0.22em] text-slate-400">Show Title</label>
            <input id="title" class="mt-2 w-full rounded-xl px-3 py-2 text-slate-50" placeholder="Your show title"/>
          </div>

          <div>
            <label class="text-xs uppercase tracking-[0.22em] text-slate-400">Creator Name</label>
            <input id="creator" class="mt-2 w-full rounded-xl px-3 py-2 text-slate-50" placeholder="@name / brand"/>
          </div>

          <div>
            <label class="text-xs uppercase tracking-[0.22em] text-slate-400">Type</label>
            <select id="type" class="mt-2 w-full rounded-xl px-3 py-2 text-slate-50">
              <option value="podcast">podcast</option>
              <option value="video">video</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="text-xs uppercase tracking-[0.22em] text-slate-400">Live URL (YouTube Live / Twitch / Embed)</label>
            <input id="url" class="mt-2 w-full rounded-xl px-3 py-2 text-slate-50" placeholder="https://youtube.com/watch?v=..."/>
          </div>

          <div class="md:col-span-2">
            <label class="text-xs uppercase tracking-[0.22em] text-slate-400">Description (optional)</label>
            <textarea id="desc" rows="3" class="mt-2 w-full rounded-xl px-3 py-2 text-slate-50" placeholder="What‚Äôs the episode about?"></textarea>
          </div>

          <div>
            <label class="text-xs uppercase tracking-[0.22em] text-slate-400">Requested Minutes</label>
            <input id="mins" type="number" min="10" max="240" value="60" class="mt-2 w-full rounded-xl px-3 py-2 text-slate-50"/>
          </div>

          <div class="flex items-end gap-2">
            <button id="submit" class="btn border border-emerald-500/40 bg-emerald-500/10 text-emerald-100 hover:bg-emerald-500/15">Submit Request</button>
            <a class="btn border border-purple-500/40 bg-purple-500/10 text-purple-100 hover:bg-purple-500/15" href="live.html">Live Page</a>
          </div>
        </div>

        <p id="m" class="text-sm text-slate-300/85 mt-4"></p>
      </div>

      <div class="card rounded-2xl p-6">
        <p class="text-slate-400 text-xs uppercase tracking-[0.28em]">Status</p>
        <h2 class="text-2xl font-extrabold mt-2">Your latest request</h2>
        <div id="status" class="mt-4 text-slate-200/85 text-sm">No requests yet.</div>
        <div class="mt-4 flex flex-wrap gap-2">
          <button id="refresh" class="btn border border-slate-500/40 bg-slate-500/10 text-slate-100 hover:bg-slate-500/15">‚Üª Refresh</button>
          <a class="btn border border-yellow-500/40 bg-yellow-500/10 text-yellow-100 hover:bg-yellow-500/15" href="owner-live-console.html">Owner Live</a>
        </div>
      </div>
    </div>
  </main>

  <script>
    const REQUIRED = ['video_creator_pass_monthly'];
    const LS_LAST = 'tkfm_last_live_request_id';

    function setMsg(text, ok){
      const m = document.getElementById('m');
      m.textContent = text;
      m.className = ok ? 'text-sm text-emerald-300 font-semibold mt-4' : 'text-sm text-red-300 font-semibold mt-4';
    }

    async function gate() {
      const locked = document.getElementById('locked');
      const unlocked = document.getElementById('unlocked');
      const msgEl = document.getElementById('lockMsg');
      if (window.TKFM_REQUIRE_ANY_SUB) {
        await window.TKFM_REQUIRE_ANY_SUB(REQUIRED, { lockedEl: locked, unlockedEl: unlocked, msgEl });
      } else {
        locked.classList.remove('hidden');
        unlocked.classList.add('hidden');
        msgEl.textContent = 'Subscription guard missing.';
      }
    }

    async function submit(){
      // Always re-check gate before submit
      await gate();
      if (!document.getElementById('unlocked') || document.getElementById('unlocked').classList.contains('hidden')) {
        setMsg('Locked. Complete the monthly checkout first.', false);
        return;
      }

      const title = (document.getElementById('title').value||'').trim();
      const creator = (document.getElementById('creator').value||'').trim();
      const type = (document.getElementById('type').value||'podcast').trim();
      const url = (document.getElementById('url').value||'').trim();
      const description = (document.getElementById('desc').value||'').trim();
      const minutes = Math.max(10, parseInt(document.getElementById('mins').value||'60',10)||60);

      if (!title || !url){
        setMsg('Missing title or URL.', false);
        return;
      }

      setMsg('Submitting‚Ä¶', true);
      try{
        const res = await fetch('/.netlify/functions/live-submit', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ title, creator, type, url, description, minutes })
        });
        const out = await res.json().catch(()=>({}));
        if (!res.ok || !out.ok) throw new Error(out.error||'submit failed');
        localStorage.setItem(LS_LAST, out.id);
        setMsg('‚úÖ Request sent. Owner will approve you for Live Now.', true);
        await refresh();
      }catch(e){
        setMsg('‚ùå Submit failed. Try again later.', false);
      }
    }

    function safe(s){ return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function statusHtml(st){
      if (!st) return 'No requests yet.';
      const badge = st.status === 'approved' ? 'border-emerald-500/40 bg-emerald-500/10 text-emerald-100'
                  : (st.status === 'denied' ? 'border-red-500/40 bg-red-500/10 text-red-100'
                  : 'border-yellow-500/40 bg-yellow-500/10 text-yellow-100');
      return `
        <div class="rounded-2xl border border-slate-700/50 bg-black/30 p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-slate-400 text-xs uppercase tracking-[0.28em]">Request ID: <span class="mono">${safe(st.id||'')}</span></p>
              <p class="text-slate-50 font-extrabold mt-2">${safe(st.title||'')}</p>
              <p class="text-slate-400 text-xs mt-2">${safe(st.creator||'')}</p>
            </div>
            <span class="px-3 py-1 rounded-full border ${badge} text-[0.65rem] uppercase tracking-[0.22em] font-extrabold">${safe(st.status||'pending')}</span>
          </div>
          <p class="text-slate-300/85 text-sm mt-3">${safe(st.description||'')}</p>
          ${st.active ? '<p class="text-emerald-300 font-semibold text-sm mt-3">üî¥ You are LIVE now. Open /live or /tv.</p>' : ''}
        </div>
      `;
    }

    async function refresh(){
      const id = localStorage.getItem(LS_LAST) || '';
      if (!id){
        document.getElementById('status').textContent = 'No requests yet.';
        return;
      }
      try{
        const res = await fetch('/.netlify/functions/live-status?id=' + encodeURIComponent(id));
        const out = await res.json().catch(()=>({}));
        document.getElementById('status').innerHTML = statusHtml(out && out.request ? out.request : null);
      }catch(e){
        document.getElementById('status').textContent = 'Status load error.';
      }
    }

    document.getElementById('submit').addEventListener('click', submit);
    document.getElementById('refresh').addEventListener('click', refresh);

    gate();
    refresh();
    setInterval(refresh, 30000);
  </script>

  <footer class="border-t border-slate-800/80 bg-black/80 backdrop-blur-xl">
    <div class="max-w-6xl mx-auto px-4 py-6 text-xs text-slate-400 flex flex-wrap items-center justify-between gap-3">
      <p>¬© <span id="year"></span> They Krave For Me Radio</p>
      <div class="flex gap-2 flex-wrap">
        <a class="hover:text-slate-200" href="contact.html">Contact</a><span>‚Ä¢</span>
        <a class="hover:text-slate-200" href="media-kit.html">Media Kit</a><span>‚Ä¢</span>
        <a class="hover:text-slate-200" href="owner-login.html">Owner Login</a>
      </div>
    </div>
  </footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>
</body>
</html>

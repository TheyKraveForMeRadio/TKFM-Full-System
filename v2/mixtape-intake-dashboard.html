<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="tkfm-theme" content="label" />
  <link rel="stylesheet" href="/css/tkfm-shell.css" />
  <link rel="stylesheet" href="/css/tkfm-label.css" />
  <script src="/js/tkfm-shell.js" defer></script>

  <meta charset="UTF-8" />
  <title>TKFM v2 â€” Mixtape Intake Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-purple-100 min-h-screen font-mono">
  <header class="border-b border-purple-700 px-6 py-4 flex items-center justify-between">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold tracking-wide">
        ðŸŽ› TKFM Mixtape Intake Dashboard
      </h1>
      <p class="text-sm text-purple-400 mt-1">
        Feed from <span class="font-semibold">mixtapeOrders</span> via Netlify Functions
      </p>
    </div>
    <div class="text-right text-xs md:text-sm text-purple-400">
      <div>Source: <span class="font-semibold">mixtape-hosting</span></div>
      <div>Status filter:
        <select id="statusFilter" class="bg-black border border-purple-600 rounded px-2 py-1 text-xs">
          <option value="pending-intake">pending-intake</option>
          <option value="approved">approved</option>
          <option value="in-contract">in-contract</option>
          <option value="completed">completed</option>
          <option value="rejected">rejected</option>
          <option value="all">all</option>
        </select>
      </div>
    </div>
  </header>

  <main class="p-4 md:p-6 max-w-6xl mx-auto">
    <!-- Status / actions bar -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div class="flex items-center gap-2 text-xs text-purple-300">
        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
        <span>Live feed from <code>/.netlify/functions/get-mixtape-intake</code></span>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="text-xs md:text-sm border border-purple-600 px-3 py-1 rounded hover:bg-purple-700">
          ðŸ”„ Refresh queue
        </button>
        <span id="lastUpdated" class="text-[10px] md:text-xs text-purple-500">
          Last updated: â€”
        </span>
      </div>
    </div>

    <!-- Table container -->
    <div class="bg-black/60 border border-purple-700 rounded-xl overflow-hidden shadow-lg">
      <div class="overflow-x-auto">
        <table class="min-w-full text-xs md:text-sm">
          <thead class="bg-purple-900/60 text-purple-100 uppercase text-[10px] md:text-xs">
            <tr>
              <th class="px-3 py-2 text-left">Tier</th>
              <th class="px-3 py-2 text-left">Artist</th>
              <th class="px-3 py-2 text-left hidden md:table-cell">Email</th>
              <th class="px-3 py-2 text-left hidden md:table-cell">Amount</th>
              <th class="px-3 py-2 text-left hidden md:table-cell">Created</th>
              <th class="px-3 py-2 text-left">Status</th>
              <th class="px-3 py-2 text-left">Action</th>
            </tr>
          </thead>
          <tbody id="ordersBody" class="divide-y divide-purple-800/40">
            <tr id="emptyRow">
              <td colspan="7" class="px-3 py-6 text-center text-purple-500">
                No records found for this status.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Toast / feedback -->
    <div id="toast"
         class="fixed bottom-4 right-4 bg-purple-900/90 border border-purple-500 text-xs md:text-sm px-3 py-2 rounded-lg shadow-xl opacity-0 pointer-events-none transition-opacity">
      <span id="toastText"></span>
    </div>
  </main>

  <script>
    const ordersBody = document.getElementById('ordersBody');
    const emptyRow = document.getElementById('emptyRow');
    const statusFilter = document.getElementById('statusFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const lastUpdated = document.getElementById('lastUpdated');
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');

    function showToast(message) {
      toastText.textContent = message;
      toast.classList.remove('opacity-0', 'pointer-events-none');
      setTimeout(() => {
        toast.classList.add('opacity-0', 'pointer-events-none');
      }, 2500);
    }

    function formatAmount(amount, currency) {
      if (!amount) return '-';
      const value = (amount / 100).toFixed(2);
      return value + ' ' + (currency || 'usd').toUpperCase();
    }

    function formatDate(iso) {
      if (!iso) return '-';
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch {
        return iso;
      }
    }

    async function fetchOrders() {
      const status = statusFilter.value;
      const qs = status === 'all' ? '?status=all' : '?status=' + encodeURIComponent(status);

      try {
        const res = await fetch('/.netlify/functions/get-mixtape-intake' + qs);
        const data = await res.json();

        // Clear body
        ordersBody.innerHTML = '';
        if (!data || !data.length) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="7" class="px-3 py-6 text-center text-purple-500">No records found for this status.</td>';
          ordersBody.appendChild(tr);
        } else {
          data.forEach(order => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-purple-900/30 transition-colors';

            const statusBadgeColor =
              order.status === 'approved' ? 'bg-green-700/70 text-green-100' :
              order.status === 'rejected' ? 'bg-red-800/70 text-red-100' :
              order.status === 'in-contract' ? 'bg-blue-700/70 text-blue-100' :
              order.status === 'completed' ? 'bg-emerald-700/70 text-emerald-100' :
              'bg-purple-800/70 text-purple-100';

            tr.innerHTML = `
              <td class="px-3 py-2 align-top">
                <div class="font-semibold text-purple-100">${order.tier || '-'}</div>
                <div class="text-[10px] text-purple-500">${order.product || ''}</div>
              </td>
              <td class="px-3 py-2 align-top">
                <div class="font-semibold">${order.name || 'Unknown Artist'}</div>
                <div class="text-[10px] text-purple-500 md:hidden">${order.email || ''}</div>
              </td>
              <td class="px-3 py-2 align-top hidden md:table-cell">
                <div class="text-[11px]">${order.email || '-'}</div>
              </td>
              <td class="px-3 py-2 align-top hidden md:table-cell">
                <div class="text-[11px]">${formatAmount(order.amount_total, order.currency)}</div>
              </td>
              <td class="px-3 py-2 align-top hidden md:table-cell">
                <div class="text-[11px]">${formatDate(order.createdAt)}</div>
              </td>
              <td class="px-3 py-2 align-top">
                <span class="inline-block px-2 py-1 rounded-full text-[10px] ${statusBadgeColor}">
                  ${order.status || 'pending-intake'}
                </span>
                <div class="text-[9px] text-purple-500 mt-1">
                  ${order.source || 'mixtape-hosting'}
                </div>
              </td>
              <td class="px-3 py-2 align-top">
                <div class="flex flex-wrap gap-1">
                  <button data-id="${order.id}" data-status="approved"
                          class="status-btn px-2 py-1 rounded text-[10px] border border-green-600 hover:bg-green-700/60">
                    âœ… Approve
                  </button>
                  <button data-id="${order.id}" data-status="rejected"
                          class="status-btn px-2 py-1 rounded text-[10px] border border-red-700 hover:bg-red-800/60">
                    ðŸš« Reject
                  </button>
                  <button data-id="${order.id}" data-status="in-contract"
                          class="status-btn px-2 py-1 rounded text-[10px] border border-blue-600 hover:bg-blue-700/60">
                    ðŸ“„ In-Contract
                  </button>
                  <button data-id="${order.id}" data-status="completed"
                          class="status-btn px-2 py-1 rounded text-[10px] border border-emerald-600 hover:bg-emerald-700/60">
                    âœ… Completed
                  </button>
                </div>
              </td>
            `;
            ordersBody.appendChild(tr);
          });
        }

        lastUpdated.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
        wireStatusButtons();
      } catch (err) {
        console.error(err);
        showToast('Error loading mixtape intake feed');
      }
    }

    function wireStatusButtons() {
      document.querySelectorAll('.status-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          const status = btn.getAttribute('data-status');

          try {
            const res = await fetch('/.netlify/functions/update-mixtape-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, status })
            });

            if (!res.ok) {
              showToast('Update failed: ' + (await res.text()));
              return;
            }

            showToast('Status updated â†’ ' + status);
            fetchOrders(); // refresh list
          } catch (err) {
            console.error(err);
            showToast('Error updating status');
          }
        };
      });
    }

    // Events
    refreshBtn.onclick = fetchOrders;
    statusFilter.onchange = fetchOrders;

    // Initial load
    fetchOrders();
  </script>
  <script src="/js/owner-lock.js" data-owner-page="owner"></script>
</body>
</html>

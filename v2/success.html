<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TKFM — Purchase Successful</title>
  <style>
    :root{--bg:#020617;--p:#a855f7;--pk:#ec4899;--c:#22d3ee;--b:#3b82f6;--txt:#e5e7eb}
    body{margin:0;background:radial-gradient(1200px 600px at 20% 0%,rgba(168,85,247,.25),transparent 55%),radial-gradient(900px 500px at 80% 10%,rgba(34,211,238,.18),transparent 60%),var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:32px}
    .card{border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:22px;background:rgba(2,6,23,.55);backdrop-filter: blur(10px)}
    .h{font-size:28px;margin:0 0 8px}
    .sub{opacity:.9;margin:0 0 18px}
    .pill{display:inline-block;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);margin:6px 8px 0 0;background:rgba(255,255,255,.04)}
    .btn{display:inline-block;margin-top:16px;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);text-decoration:none;color:var(--txt);background:rgba(255,255,255,.06)}
    .btn:hover{border-color:rgba(236,72,153,.45)}
    .muted{opacity:.75;font-size:13px;margin-top:12px}
    code{background:rgba(0,0,0,.25);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="h">✅ You’re unlocked.</h1>
      <p class="sub">Verifying your checkout + activating TKFM features.</p>

      <div id="status">Verifying…</div>
      <div id="features" style="margin-top:12px"></div>

      <div style="margin-top:14px">
        <span class="pill" id="entStatus">Entitlements: —</span>
      </div>

      <a class="btn" href="/pricing.html">Back to Pricing</a>
      <a class="btn" href="/radio-hub.html">Go to Radio Hub</a>

      <div class="muted">
        Session: <code id="sid">—</code>
        &nbsp;•&nbsp; Customer: <code id="cid">—</code>
      </div>
    </div>
  </div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const sid = params.get('session_id');

  const statusEl = document.getElementById('status');
  const featuresEl = document.getElementById('features');
  const entEl = document.getElementById('entStatus');
  const sidEl = document.getElementById('sid');
  const cidEl = document.getElementById('cid');

  sidEl.textContent = sid || 'missing';

  function getFeatures(){
    try { return JSON.parse(localStorage.getItem('tkfm_user_features') || '[]') || []; }
    catch(e){ return []; }
  }
  function setFeatures(arr){
    localStorage.setItem('tkfm_user_features', JSON.stringify(Array.from(new Set(arr || []))));
  }
  function setCustomerId(cid){
    if (!cid) return;
    localStorage.setItem('tkfm_stripe_customer_id', String(cid));
  }

  async function loadEntitlements(cid){
    if (!cid) return;
    cidEl.textContent = cid;
    try{
      const r = await fetch('/.netlify/functions/get-entitlements?customer_id=' + encodeURIComponent(cid));
      const d = await r.json().catch(()=> ({}));
      if (d && d.ok && d.enabled) {
        entEl.textContent = 'Entitlements: ' + (d.status || 'unknown');
      } else {
        entEl.textContent = 'Entitlements: —';
      }
    } catch(e){
      entEl.textContent = 'Entitlements: —';
    }
  }

  if(!sid){
    statusEl.textContent = 'Missing session_id. Return to pricing and try again.';
    return;
  }

  fetch('/.netlify/functions/verify-checkout-session?session_id=' + encodeURIComponent(sid))
    .then(r => r.json())
    .then(data => {
      if(!data || !data.ok){
        statusEl.textContent = 'Verification failed. Try refresh.';
        return;
      }

      const unlocked = data.unlocked || [];
      const current = getFeatures();
      setFeatures(current.concat(unlocked));

      statusEl.textContent = unlocked.length ? 'Activated:' : 'No mapped items found (check STRIPE_PRICE_* env).';
      featuresEl.innerHTML = unlocked.length
        ? unlocked.map(x => '<span class="pill">'+x+'</span>').join('')
        : '<span class="pill">none</span>';

      if (data.customer) {
        setCustomerId(data.customer);
        loadEntitlements(data.customer);
      }
    })
    .catch(() => {
      statusEl.textContent = 'Verification error. Try refresh.';
    });
})();
</script>
</body>
</html>

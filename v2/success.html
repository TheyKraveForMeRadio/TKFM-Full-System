<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TKFM — Payment Success</title>
  <style>
    :root { --bg:#020617; --p:#a855f7; --pk:#ec4899; --c:#22d3ee; --b:#3b82f6; }
    html,body{height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{
      background:
        radial-gradient(800px 400px at 20% 15%, rgba(168,85,247,.25), transparent 60%),
        radial-gradient(700px 380px at 70% 25%, rgba(236,72,153,.20), transparent 60%),
        radial-gradient(800px 420px at 60% 80%, rgba(34,211,238,.18), transparent 60%),
        var(--bg);
      color:#e5e7eb;
      display:flex; align-items:center; justify-content:center;
    }
    .card{
      width:min(740px, 92vw);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(2,6,23,.75);
      backdrop-filter: blur(10px);
      border-radius:18px;
      padding:26px;
      box-shadow: 0 0 0 1px rgba(168,85,247,.12), 0 12px 50px rgba(0,0,0,.55);
    }
    .title{font-size:24px; font-weight:900; letter-spacing:.4px; margin:0 0 8px;}
    .sub{opacity:.9; margin:0 0 18px;}
    .bar{
      height:10px; border-radius:999px;
      background: linear-gradient(90deg, var(--p), var(--pk), var(--c), var(--b));
      filter: drop-shadow(0 0 10px rgba(168,85,247,.25));
      margin: 16px 0 14px;
    }
    .small{opacity:.85; font-size:13px; line-height:1.5;}
    a{color: var(--c); text-decoration:none;}
  </style>
</head>
<body>
  <div class="card">
    <p class="title">Payment confirmed</p>
    <p class="sub">Unlocking your TKFM features…</p>
    <div class="bar"></div>
    <p class="small" id="msg">Do not close this tab.</p>
    <p class="small"><a href="/pricing.html">Back to Pricing</a></p>
  </div>

  <script type="module">
    const FN_VERIFY = '/.netlify/functions/verify-checkout-session';

    function qs(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    function setUnlock(unlock_id, unlock){
      const feats = JSON.parse(localStorage.getItem('tkfm_user_features') || '{}');
      const stamp = Date.now();

      if (unlock_id) feats[unlock_id] = { ok:true, at: stamp };

      if (unlock && Array.isArray(unlock.features)) {
        unlock.features.forEach(f => { feats[f] = { ok:true, at: stamp }; });
      }

      localStorage.setItem('tkfm_user_features', JSON.stringify(feats));

      if (unlock && unlock.tier) {
        localStorage.setItem('tkfm_memberTier', unlock.tier);
      }
    }

    async function run(){
      const el = document.getElementById('msg');
      const session_id = qs('session_id');

      if (!session_id) {
        el.textContent = 'Missing session id. Returning…';
        window.location.href = '/pricing.html';
        return;
      }

      const res = await fetch(FN_VERIFY, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ session_id })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.paid) {
        el.textContent = 'Payment not confirmed yet. Returning…';
        window.location.href = '/pricing.html';
        return;
      }

      setUnlock(data.unlock_id, data.unlock || {});
      if (data.customer_email) localStorage.setItem('tkfm_member_email', String(data.customer_email).toLowerCase());
      el.textContent = 'Unlocked. Redirecting…';

      const ret = localStorage.getItem('tkfm_return_url') || '/pricing.html';
      localStorage.removeItem('tkfm_return_url');
      window.location.href = ret;
    }

    run();
  </script>
</body>
</html>

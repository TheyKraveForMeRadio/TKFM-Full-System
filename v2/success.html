<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TKFM — Success</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      background:#020617;
      background-image:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.22),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(236,72,153,0.30),transparent 55%),
        radial-gradient(circle at 50% 100%,rgba(168,85,247,0.28),transparent 55%),
        radial-gradient(circle at 60% 50%,rgba(250,204,21,0.08),transparent 60%);
    }
    .card{background:rgba(2,6,23,.55);border:1px solid rgba(148,163,184,.18)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .pill{font-size:.7rem;letter-spacing:.28em;text-transform:uppercase}
  </style>
</head>
<body class="text-slate-50 min-h-screen">
  <main class="max-w-2xl mx-auto px-4 pt-14 pb-14">
    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-emerald-400/80 bg-emerald-400/10 pill text-emerald-200">
      <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
      <span>Payment Success</span>
    </div>

    <h1 class="text-3xl md:text-5xl font-extrabold leading-tight mt-5">
      You’re locked in.
    </h1>

    <p class="text-slate-200/85 mt-4">
      We’re confirming your purchase with Stripe, then unlocking your TKFM features.
    </p>

    <div class="card rounded-2xl p-6 mt-8 space-y-3">
      <p class="text-slate-400 text-xs uppercase tracking-[0.28em]">Status</p>
      <div id="status" class="text-lg font-extrabold">Checking…</div>
      <div id="details" class="text-sm text-slate-200/85"></div>
    </div>

    <div class="mt-6 flex flex-wrap gap-2">
      <a href="radio-hub.html" class="px-4 py-2 rounded-full border border-sky-400/60 bg-sky-400/10 text-sky-100 font-extrabold text-xs uppercase tracking-[0.22em]">Go to Radio</a>
      <a href="engines.html" class="px-4 py-2 rounded-full border border-purple-400/60 bg-purple-400/10 text-purple-100 font-extrabold text-xs uppercase tracking-[0.22em]">Open Engines</a>
      <a href="unlocks.html" class="px-4 py-2 rounded-full border border-yellow-400/60 bg-yellow-400/10 text-yellow-100 font-extrabold text-xs uppercase tracking-[0.22em]">Manage Unlocks</a>
    </div>

    <p class="text-xs text-slate-500 mt-8">
      If you don’t see your unlock in 10 seconds, refresh this page.
    </p>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);
    const session_id = qs.get('session_id');

    const LS_FEATURES = 'tkfm_user_features';
    const LS_EMAIL = 'tkfm_customer_email';

    function getFeatures(){
      try { return JSON.parse(localStorage.getItem(LS_FEATURES) || '[]') || []; } catch(e){ return []; }
    }
    function setFeatures(arr){
      localStorage.setItem(LS_FEATURES, JSON.stringify(Array.from(new Set(arr))));
    }

    function setStatus(title, details){
      document.getElementById('status').textContent = title;
      document.getElementById('details').innerHTML = details || '';
    }

    function esc(s){ return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    async function run(){
      if (!session_id){
        setStatus('Missing session_id', 'No Stripe session_id found in the URL.');
        return;
      }

      setStatus('Confirming with Stripe…', 'Session: <span class="mono">' + esc(session_id) + '</span>');

      try{
        const res = await fetch('/.netlify/functions/session-info?session_id=' + encodeURIComponent(session_id));
        const data = await res.json().catch(()=>({}));

        if (!data || !data.ok){
          setStatus('Could not confirm purchase', esc(data && data.error ? data.error : 'Unknown error'));
          return;
        }

        if (data.email) localStorage.setItem(LS_EMAIL, data.email);

        const planId = data.planId;
        const mode = data.mode;

        if (!planId){
          setStatus('Confirmed — but missing planId', 'Session confirmed. PlanId missing from metadata.');
          return;
        }

        // Subscription must be active/trialing to count as unlocked
        if (mode === 'subscription') {
          const st = String(data.subscription_status || '');
          const ok = (st === 'active' || st === 'trialing');
          if (!ok){
            setStatus('Subscription pending', 'We see your subscription, but status is: <span class="mono">' + esc(st || 'unknown') + '</span>. Refresh in a moment.');
            return;
          }
        } else {
          // payment: require paid
          const ps = String(data.payment_status || '');
          if (ps && ps !== 'paid'){
            setStatus('Payment pending', 'Payment status: <span class="mono">' + esc(ps) + '</span>. Refresh in a moment.');
            return;
          }
        }

        // Unlock locally
        const feats = getFeatures();
        if (!feats.includes(planId)) feats.push(planId);
        setFeatures(feats);

        setStatus('✅ Unlocked: ' + planId, 
          'Mode: <span class="mono">' + esc(mode) + '</span>' + 
          (data.email ? (' • Email: <span class="mono">' + esc(data.email) + '</span>') : '')
        );

        // Fast redirect back
        setTimeout(() => {
          location.href = 'unlocks.html';
        }, 1400);

      }catch(e){
        setStatus('Network error', 'Could not reach Stripe verification function.');
      }
    }

    run();
  </script>
</body>
</html>
